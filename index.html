<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Hoho3D – Rueda de Color + Ideas (sin API)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --bg:#0b0c0f; --card:#111317; --muted:#9aa1ac; --text:#e8ecf1; --accent:#3b82f6; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); background:linear-gradient(120deg,#0b0c0f,#0f1218); }
    header{ padding:12px 20px; border-bottom:1px solid #1b1f28; background:#0b0c0fd9; display:flex; gap:12px; align-items:center }
    header h1{ margin:0; font-size:16px; font-weight:600 }
    .app{ display:grid; grid-template-columns:420px minmax(380px,540px); gap:20px; padding:20px; max-width:1100px; margin:0 auto; align-items:start }
    .left,.right{ background:var(--card); border:1px solid #1b1f28; border-radius:14px; padding:16px }
    #wheel{ width:360px; height:360px; display:block; margin:8px auto 10px; border-radius:12px; border:1px solid #1b1f28; cursor:crosshair }
    .current{ display:flex; gap:8px; align-items:center; font-size:14px; color:var(--muted); margin-top:6px }
    .current .sw{ width:20px; height:20px; border-radius:6px; border:1px solid #1b1f28 }
    .preview-img{ width:100%; max-width:380px; height:220px; object-fit:cover; border-radius:12px; border:1px solid #1b1f28; display:block; margin:10px auto 0 }
    .main-sw{ width:100%; height:110px; border-radius:10px; border:1px solid #1b1f28; margin-bottom:10px }
    .meta{ display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:14px; color:var(--muted) }
    .meta div strong{ color:var(--text); font-weight:600 }
    .btn{ appearance:none; border:1px solid #223047; background:#131824; color:#dbe6f7; padding:8px 10px; border-radius:10px; font-size:14px; cursor:pointer }
    .btn:hover{ border-color:#2b3a55 }
    .ideas{ margin-top:12px; padding:12px; background:#0f1218; border:1px solid #1b1f28; border-radius:10px }
    .ideas h3{ margin:0 0 6px 0; font-size:16px }
    @media (max-width:980px){ .app{ grid-template-columns:1fr } #wheel{ width:100%; height:auto } }
  </style>
</head>
<body>
<header>
  <h1>Hoho3D · Búsqueda por color</h1>
</header>

<main class="app">
  <section class="left">
    <div id="loading" style="color:var(--muted); font-size:14px">Cargando catálogo...</div>
    <canvas id="wheel" width="360" height="360" aria-label="Rueda de color HSV"></canvas>
    <div class="current">
      <div class="sw" id="sel-sw"></div>
      <div><strong>RGB:</strong> <span id="sel-rgb">—</span> · <strong>HEX:</strong> <span id="sel-hex">—</span></div>
    </div>
    <img id="preview-img" class="preview-img" alt="Vista previa de filamento" />
  </section>

  <section class="right">
    <div class="main-sw" id="main-sw"></div>
    <h2 id="main-name">—</h2>
    <div class="meta">
      <div><strong>Marca:</strong> <span id="main-brand">—</span></div>
      <div><strong>Tipo:</strong> <span id="main-type">—</span></div>
      <div><strong>Estilo:</strong> <span id="main-style">—</span></div>
      <div><strong>Temp.:</strong> <span id="main-temp">—</span></div>
      <div><strong>Resist.:</strong> <span id="main-strength">—</span></div>
      <div><strong>HEX:</strong> <span id="main-hex">—</span></div>
    </div>

    <!-- Botón de tienda arriba -->
    <div style="margin-top:8px; margin-bottom:12px;">
      <a id="main-link" class="btn" href="#" target="_blank" rel="noopener">Abrir en tienda</a>
    </div>

    <!-- Creador de Ideas -->
    <button id="ideas-show" class="btn" type="button">Creador de Ideas</button>
    <div class="ideas" id="ideas-box" style="display:none; margin-top:8px;">
      <h3>Ideas</h3>
      <ul id="ideas-list" style="margin:0; padding-left:18px;"></ul>
      <button id="ideas-refresh" class="btn" type="button" style="margin-top:8px;">Regenerar ideas</button>
    </div>
  </section>
</main>

<script>
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ-GFIahnmzB09C1GWCvAs1PaNXmpN2_Ed5taWtseTRlqx0P8-ZKJ28TOsvziFOw/pub?output=tsv";

const clamp=(n,a,b)=>Math.min(b,Math.max(a,n));
const norm=s=>s==null?'':String(s).trim();
const SPLIT_RE=/\s*[,;|\n]\s*/g;

// Color utils
function normalizeHex(h){ if(typeof h!=='string')return null; const s=h.trim(); const r3=/^#?[0-9a-fA-F]{3}$/, r6=/^#?[0-9a-fA-F]{6}$/; if(r3.test(s)){const p=s.replace('#','');return '#'+p.split('').map(c=>c+c).join('').toLowerCase()} if(r6.test(s))return '#'+s.replace('#','').toLowerCase(); return null }
function hexToRgb(hex){ const h=hex.replace('#',''); return { r:parseInt(h.slice(0,2),16), g:parseInt(h.slice(2,4),16), b:parseInt(h.slice(4,6),16) } }
function rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>clamp(Math.round(v),0,255).toString(16).padStart(2,'0')).join('') }
function rgbFromHsv(h,s,v){ h=+h; s=+s; v=+v; if(s===0){const g=Math.round(v*255); return {r:g,g,b:g}} let i=Math.floor(h*6), f=h*6-i, p=v*(1-s), q=v*(1-s*f), t=v*(1-s*(1-f)); i%=6; let r,g,b; if(i===0){r=v;g=t;b=p}else if(i===1){r=q;g=v;b=p}else if(i===2){r=p;g=v;b=t}else if(i===3){r=p;g=q;b=v}else if(i===4){r=t;g=p;b=v}else{r=v;g=p;b=q} return {r:Math.round(r*255),g:Math.round(g*255),b:Math.round(b*255)} }
function hsvFromRgb(r,g,b){ r/=255; g/=255; b/=255; const max=Math.max(r,g,b),min=Math.min(r,g,b); let h,s,v=max; const d=max-min; s=max===0?0:d/max; if(max===min){h=0}else{ switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;} h/=6 } return {h,s,v} }
function shiftHue(hex,deg){ const {r,g,b}=hexToRgb(hex); const hsv=hsvFromRgb(r,g,b); let h=hsv.h+(deg/360); h=(h%1+1)%1; const out=rgbFromHsv(h,Math.min(1,Math.max(0,hsv.s)),hsv.v); return rgbToHex(out.r,out.g,out.b) }
function paletteFromHex(hex){ const comp=shiftHue(hex,180); const tri1=shiftHue(hex,120), tri2=shiftHue(hex,-120); const ana1=shiftHue(hex,30), ana2=shiftHue(hex,-30); return { comp, tri:[tri1,tri2], ana:[ana1,ana2] } }

const wheel=document.getElementById('wheel'); const ctx=wheel.getContext('2d'); const CX=wheel.width/2, CY=wheel.height/2, R=170;
let items=[], pool=[], lastRGB=null, dragging=false, currentItem=null;

function drawWheel(){ const img=ctx.createImageData(wheel.width,wheel.height); for(let y=0;y<wheel.height;y++){ for(let x=0;x<wheel.width;x++){ const dx=x-CX, dy=y-CY, dist=Math.hypot(dx,dy); if(dist<=R){ let ang=Math.atan2(dy,dx); if(ang<0) ang+=Math.PI*2; const hue=ang/(Math.PI*2), sat=dist/R; const {r,g,b}=rgbFromHsv(hue,sat,1); const i=(y*wheel.width+x)*4; img.data[i]=r; img.data[i+1]=g; img.data[i+2]=b; img.data[i+3]=255; } } } ctx.putImageData(img,0,0) }
function colorDistance(a,b){ const dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b; return Math.sqrt(dr*dr+dg*dg+db*db) }

const parseIdeas = raw => { const s=norm(raw); if(!s) return []; return s.split(SPLIT_RE).map(x=>x.trim()).filter(Boolean) };

async function cargar(){
  const el=document.getElementById('loading'); el.style.display='block';
  try{
    const res=await fetch(sheetUrl,{cache:'no-store',mode:'cors'}); let text=await res.text();
    text=text.replace(/^\uFEFF/,'').replace(/\r\n/g,'\n');
    const head=text.split('\n')[0]; const delim=head.includes('\t')?'\t':',';
    const rows=text.trim().split('\n').map(l=>l.split(delim));
    const headers=rows.shift().map(h=>h.replace(/^"(.*)"$/,'$1').trim().toLowerCase());
    const ix=k=>headers.indexOf(k);
    const idx={
      id: ix('id'), name: ix('name'), hex: ix('hex'), brand: ix('brand'),
      type: ix('type'), style: ix('style'), temp: ix('temp'),
      strength: ix('strength'), link: ix('link'), img: ix('img'), ideas: ix('ideas')
    };
    items=[];
    rows.forEach(r=>{
      const hex=normalizeHex(r[idx.hex]||''); if(!hex) return;
      const obj={
        id: idx.id!==-1? norm(r[idx.id]) : '',
        name: norm(r[idx.name]),
        hex, rgb: hexToRgb(hex),
        brand: norm(r[idx.brand]),
        type: norm(r[idx.type]),
        style: norm(r[idx.style]),
        temp: norm(r[idx.temp]),
        strength: norm(r[idx.strength]),
        link: norm(r[idx.link]),
        img: norm(r[idx.img]),
        ideas: idx.ideas!==-1? parseIdeas(r[idx.ideas]) : []
      };
      if(!obj.id){ const slug=(obj.name||'filamento').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); obj.id=`${slug}-${hex.replace('#','')}`; }
      items.push(obj);
    });
    pool=items.slice();
  }catch(e){ console.error(e) }
  finally{ el.style.display='none' }
}

function generateIdeasOffline(hex, item){
  const pal=paletteFromHex(hex), out=[];
  out.push(`Combinar con complementario ${pal.comp} para alto contraste.`);
  out.push(`Paleta análoga: ${pal.ana[0]} + ${pal.ana[1]} para piezas suaves.`);
  out.push(`Triádica: ${pal.tri[0]} + ${pal.tri[1]} para acentos.`);
  if(item?.type?.toLowerCase().includes('pla')) out.push(`Temperatura sugerida: ${item.temp||'200–215°C'} (según boquilla).`);
  if(item?.style?.toLowerCase().includes('silk')) out.push(`Silk: reducí velocidad para mejorar el brillo.`);
  return out;
}

function renderIdeasList(item){
  const box=document.getElementById('ideas-box');
  const ul=document.getElementById('ideas-list');
  ul.innerHTML='';
  const list=(item.ideas && item.ideas.length)? item.ideas : generateIdeasOffline(item.hex, item);
  list.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li) });
  box.style.display='block';
}

function renderMainCard(a){
  if(!a) return;
  currentItem=a;
  document.getElementById('main-sw').style.background=a.hex;
  document.getElementById('main-name').textContent=a.name||'Sin nombre';
  document.getElementById('main-brand').textContent=a.brand||'-';
  document.getElementById('main-type').textContent=a.type||'-';
  document.getElementById('main-style').textContent=a.style||'-';
  document.getElementById('main-temp').textContent=a.temp||'-';
  document.getElementById('main-strength').textContent=a.strength||'-';
  document.getElementById('main-hex').textContent=a.hex;
  document.getElementById('main-link').href=a.link||'#';
  const prev=document.getElementById('preview-img');
  if(a.img){ prev.src=a.img; prev.style.display='block' } else { prev.removeAttribute('src'); prev.style.display='none' }
  document.getElementById('ideas-box').style.display='none'; // ocultar ideas al cambiar de filamento
}

function rankAndRenderBy(rgb){
  if(!pool.length) return;
  const top=pool.map(it=>({it,d:colorDistance(rgb,it.rgb)})).sort((a,b)=>a.d-b.d)[0]?.it;
  if(top) renderMainCard(top);
}

function updateFromPoint(clientX,clientY){
  const rect=wheel.getBoundingClientRect(), scaleX=wheel.width/rect.width, scaleY=wheel.height/rect.height;
  const x=(clientX-rect.left)*scaleX, y=(clientY-rect.top)*scaleY;
  const dx=x-CX, dy=y-CY, dist=Math.hypot(dx,dy); if(dist>R) return;
  let ang=Math.atan2(dy,dx); if(ang<0) ang+=Math.PI*2;
  const hue=ang/(Math.PI*2), sat=dist/R; const {r,g,b}=rgbFromHsv(hue,sat,1);
  const hex=rgbToHex(r,g,b); lastRGB={r,g,b};
  document.getElementById('sel-rgb').textContent=`${r}, ${g}, ${b}`;
  document.getElementById('sel-hex').textContent=hex;
  document.getElementById('sel-sw').style.background=hex;
  rankAndRenderBy({r,g,b});
}

function onDown(e){ dragging=true; const p=e.touches?e.touches[0]:e; updateFromPoint(p.clientX,p.clientY) }
function onMove(e){ if(!dragging) return; const p=e.touches?e.touches[0]:e; updateFromPoint(p.clientX,p.clientY) }
function onUp(){ dragging=false }

// UI eventos
document.getElementById('ideas-show').addEventListener('click', ()=>{
  if(currentItem){
    renderIdeasList(currentItem);
  }
});
document.getElementById('ideas-refresh').addEventListener('click', ()=>{
  if(currentItem) renderIdeasList(currentItem);
});

// Init
drawWheel();
window.addEventListener('DOMContentLoaded', async()=>{ await cargar() });
wheel.addEventListener('mousedown',onDown); window.addEventListener('mousemove',onMove); window.addEventListener('mouseup',onUp);
wheel.addEventListener('touchstart',onDown,{passive:false}); window.addEventListener('touchmove',onMove,{passive:false}); window.addEventListener('touchend',onUp);
</script>
</body>
</html>
