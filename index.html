<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Hoho3D – Búsqueda por color</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --bg:#0b0c0f; --card:#111317; --muted:#9aa1ac; --text:#e8ecf1; --accent:#3b82f6; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); background:linear-gradient(120deg,#0b0c0f,#0f1218); }
    header{ padding:10px 16px; border-bottom:1px solid #1b1f28; background:#0b0c0fd9; position:sticky; top:0; z-index:5 }
    header h1{ margin:0; font-size:15px; font-weight:600 }

    .app{ display:grid; grid-template-columns: 440px minmax(380px,540px); gap:16px; padding:16px; max-width:1140px; margin:0 auto; align-items:start }
    .left,.right{ background:var(--card); border:1px solid #1b1f28; border-radius:12px; padding:12px }

    /* === Picker circular (HSV wheel + slider V) === */
    .picker{ display:grid; gap:10px; justify-items:center }
    .wheel-wrap{ position:relative; width:360px; height:360px; }
    #wheel{ width:360px; height:360px; display:block; border-radius:50%; border:1px solid #1b1f28; cursor:crosshair; background:#000; }
    #wheel-cursor{ position:absolute; width:14px; height:14px; border:2px solid #fff; border-radius:50%; transform:translate(-7px,-7px); pointer-events:none; box-shadow:0 0 0 1px #0008 }
    .v-wrap{ position:relative; width:360px; height:18px; }
    #vbar{ width:360px; height:18px; display:block; border-radius:10px; border:1px solid #1b1f28; cursor:ew-resize; }
    #v-cursor{ position:absolute; top:50%; width:10px; height:20px; border:2px solid #fff; border-radius:4px; transform:translate(-5px,-50%); pointer-events:none; box-shadow:0 0 0 1px #0008 }

    .inputs{ display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap }
    .input{ padding:8px 10px; border-radius:10px; border:1px solid #223047; background:#131824; color:#dbe6f7; font-size:14px; width:110px }
    .input.small{ width:80px; text-align:center }
    .btn{ appearance:none; border:1px solid #223047; background:#131824; color:#dbe6f7; padding:6px 10px; border-radius:10px; font-size:13px; cursor:pointer }
    .btn[disabled]{ opacity:.5; cursor:not-allowed }
    .btn:hover{ border-color:#2b3a55 }

    .current{ display:flex; gap:8px; align-items:center; font-size:13px; color:var(--muted); margin-top:4px; justify-content:center }
    .current .sw{ width:20px; height:20px; border-radius:6px; border:1px solid #1b1f28 }

    .preview-img{ width:100%; max-width:400px; height:210px; object-fit:cover; border-radius:10px; border:1px solid #1b1f28; display:block; margin:10px auto 0; cursor:pointer }

    /* Buscador + filtro tipo (panel derecho) */
    .search-right{ position:relative; margin:0 0 10px; display:flex; gap:8px; align-items:center; }
    .search-right .input{ width:100%; }
    #type-filter-btn{
      white-space:nowrap; padding:8px 10px; border-radius:12px; border:1px solid #223047;
      background:#131824; color:#dbe6f7; font-size:14px; cursor:pointer;
    }
    #type-menu{
      position:absolute; right:0; top:44px; min-width:190px; background:var(--card);
      border:1px solid #1b1f28; border-radius:10px; padding:6px; display:none; z-index:30;
    }
    #type-menu.open{ display:block; }
    .type-opt{ padding:8px 10px; border-radius:8px; cursor:pointer; font-size:14px; }
    .type-opt:hover{ background:#0f1218; }
    .type-opt.active{ outline:1px solid #2b3a55; }

    .suggestions{ position:absolute; top:44px; left:0; right:0; max-height:260px; overflow:auto; background:var(--card); border:1px solid #1b1f28; border-radius:10px; padding:6px; display:none; z-index:20 }
    .sug-item{ display:grid; grid-template-columns:18px 1fr auto; gap:8px; align-items:center; padding:6px; border-radius:8px; cursor:pointer; font-size:13px }
    .sug-item:hover{ background:#0f1218 }
    .sug-dot{ width:18px; height:18px; border-radius:6px; border:1px solid #1b1f28 }
    .sug-meta{ color:var(--muted); font-size:11px }

    .main-sw{ width:100%; height:140px; border-radius:12px; border:1px solid #1b1f28; margin-bottom:10px }
    h2{ margin:2px 0 8px 0; font-size:20px }
    .meta{ display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px; color:var(--muted) }
    .meta strong{ color:var(--text) }
    .actions{ display:flex; gap:8px; margin:8px 0 6px }

    .subs{ margin-top:8px; display:grid; gap:8px }
    .sub{ display:grid; grid-template-columns:50px 1fr auto; gap:8px; align-items:center; padding:8px; border:1px solid #1b1f28; border-radius:10px; background:#0f1218 }
    .sub .sw{ width:50px; height:42px; border-radius:8px; border:1px solid #1b1f28 }
    .sub h3{ margin:0; font-size:14px }
    .sub small{ color:var(--muted); font-size:12px }
    .sub .btn-mini{ padding:5px 8px; font-size:12px }
    .chip{ display:inline-block; padding:2px 6px; border-radius:999px; border:1px solid #2b3a55; font-size:11px; color:#bcd0ff; margin-left:6px; }

    .ideas{ margin-top:8px; padding:10px; background:#0f1218; border:1px solid #1b1f28; border-radius:10px }
    .ideas h3{ margin:0 0 6px 0; font-size:15px }

    /* Lightbox con fade + zoom */
    .lightbox{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; background:rgba(0,0,0,0); opacity:0; transition:opacity .2s ease, background .2s ease }
    .lightbox.open{ display:flex; }
    .lightbox.show{ opacity:1; background:rgba(0,0,0,.85); }
    .lightbox img{ max-width:min(92vw,1100px); max-height:90vh; display:block; transform:scale(.96); transition:transform .2s ease, opacity .2s ease; opacity:0 }
    .lightbox.show img{ transform:scale(1); opacity:1 }
    .lightbox .close{ position:absolute; top:10px; right:10px; padding:6px 10px; border:0; border-radius:8px; background:#fff; cursor:pointer; z-index:2 }
  </style>
</head>
<body>
  <header><h1>Hoho3D · Búsqueda por color</h1></header>

  <main class="app">
    <!-- IZQUIERDA: Picker circular + vista previa -->
    <section class="left">
      <div id="loading" style="color:var(--muted); font-size:13px">Cargando catálogo...</div>

      <div class="picker">
        <div class="wheel-wrap">
          <canvas id="wheel" width="360" height="360" aria-label="Rueda HSV"></canvas>
          <div id="wheel-cursor"></div>
        </div>
        <div class="v-wrap">
          <canvas id="vbar" width="360" height="18" aria-label="Slider de Valor (V)"></canvas>
          <div id="v-cursor"></div>
        </div>
        <div class="inputs">
          <input id="hex" class="input" placeholder="#rrggbb" />
          <input id="r" class="input small" placeholder="R" inputmode="numeric" />
          <input id="g" class="input small" placeholder="G" inputmode="numeric" />
          <input id="b" class="input small" placeholder="B" inputmode="numeric" />
          <button id="eyedrop" class="btn" type="button" title="Cuentagotas del sistema">🎯 Cuentagotas</button>
        </div>
      </div>

      <div class="current">
        <div class="sw" id="sel-sw"></div>
        <div><strong>RGB:</strong> <span id="sel-rgb">—</span> · <strong>HEX:</strong> <span id="sel-hex">—</span></div>
      </div>

      <img id="preview-img" class="preview-img" alt="Vista previa de filamento" />
    </section>

    <!-- DERECHA: Buscador + tarjeta + sugerencias + ideas -->
    <section class="right">
      <div class="search-right">
        <input id="q" class="input" type="search" placeholder="Buscar por color, marca o #hex…" autocomplete="off" />
        <button id="type-filter-btn" type="button" aria-haspopup="listbox" aria-expanded="false">Tipo: Todos ▾</button>
        <div id="type-menu" role="listbox" aria-label="Filtrar por tipo"></div>
        <div id="sugs" class="suggestions" role="listbox" aria-label="Resultados de búsqueda"></div>
      </div>

      <div class="main-sw" id="main-sw"></div>
      <h2 id="main-name">—</h2>
      <div class="meta">
        <div><strong>Marca:</strong> <span id="main-brand">—</span></div>
        <div><strong>Tipo:</strong> <span id="main-type">—</span></div>
        <div><strong>Estilo:</strong> <span id="main-style">—</span></div>
        <div><strong>Temp.:</strong> <span id="main-temp">—</span></div>
        <div><strong>Resist.:</strong> <span id="main-strength">—</span></div>
        <div><strong>HEX:</strong> <span id="main-hex">—</span></div>
      </div>
      <div class="actions">
        <a id="main-link" class="btn" href="#" target="_blank" rel="noopener">Abrir en tienda</a>
        <button id="ideas-show" class="btn" type="button">Creador de Ideas</button>
      </div>

      <div class="ideas" id="ideas-box" style="display:none;">
        <h3>Ideas</h3>
        <ul id="ideas-list" style="margin:0; padding-left:18px;"></ul>
        <button id="ideas-refresh" class="btn" type="button" style="margin-top:6px;">Regenerar ideas</button>
      </div>

      <div class="subs" id="subs">
        <div class="sub" id="sub-1">
          <div class="sw" id="sub1-sw"></div>
          <div>
            <h3 id="sub1-name">— <span class="chip" id="sub1-chip" style="display:none;"></span></h3>
            <small id="sub1-desc">—</small>
          </div>
          <button class="btn btn-mini" id="sub1-btn">Ver</button>
        </div>
        <div class="sub" id="sub-2">
          <div class="sw" id="sub2-sw"></div>
          <div>
            <h3 id="sub2-name">— <span class="chip" id="sub2-chip" style="display:none;"></span></h3>
            <small id="sub2-desc">—</small>
          </div>
          <button class="btn btn-mini" id="sub2-btn">Ver</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox">
    <button class="close" id="lb-close">Cerrar</button>
    <img id="lb-img" alt="Imagen del filamento" />
  </div>

  <script>
    /* ====== CONFIG ====== */
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ-GFIahnmzB09C1GWCvAs1PaNXmpN2_Ed5taWtseTRlqx0P8-ZKJ28TOsvziFOw/pub?output=tsv";

    /* ====== UTIL ====== */
    const clamp=(n,a,b)=>Math.min(b,Math.max(a,n));
    const norm=s=>s==null?'':String(s).trim();
    const SPLIT_RE=/\s*[,;|\n]\s*/g;

    function normalizeHex(h){ if(typeof h!=='string')return null; const s=h.trim();
      const r3=/^#?[0-9a-fA-F]{3}$/; const r6=/^#?[0-9a-fA-F]{6}$/;
      if(r3.test(s)){ const p=s.replace('#',''); return '#'+p.split('').map(c=>c+c).join('').toLowerCase(); }
      if(r6.test(s)) return '#'+s.replace('#','').toLowerCase();
      return null;
    }
    function hexToRgb(hex){ const h=hex.replace('#',''); return { r:parseInt(h.slice(0,2),16), g:parseInt(h.slice(2,4),16), b:parseInt(h.slice(4,6),16) } }
    function rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>clamp(Math.round(v),0,255).toString(16).padStart(2,'0')).join('') }
    function rgbFromHsv(h,s,v){ h=+h; s=+s; v=+v; if(s===0){const g=Math.round(v*255); return {r:g,g,b:g}}
      let i=Math.floor(h*6), f=h*6-i, p=v*(1-s), q=v*(1-s*f), t=v*(1-s*(1-f)); i%=6; let r,g,b;
      if(i===0){r=v;g=t;b=p}else if(i===1){r=q;g=v;b=p}else if(i===2){r=p;g=v;b=t}else if(i===3){r=p;g=q;b=v}else if(i===4){r=t;g=p;b=v}else{r=v;g=p;b=q}
      return { r:Math.round(r*255), g:Math.round(g*255), b:Math.round(b*255) };
    }
    function hsvFromRgb(r,g,b){ r/=255; g/=255; b/=255; const max=Math.max(r,g,b),min=Math.min(r,g,b); let h,s,v=max; const d=max-min; s=max===0?0:d/max; if(max===min){h=0}else{switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break}h/=6} return {h,s,v}; }

    /* ====== Estado ====== */
    let items=[], pool=[], lastRGB=null, currentItem=null;

    /* ====== Ideas (desde columna "ideas" o generadas) ====== */
    const parseIdeas = raw => { const s=norm(raw); if(!s) return []; return s.split(SPLIT_RE).map(x=>x.trim()).filter(Boolean) };
    function shiftHue(hex,deg){ const {r,g,b}=hexToRgb(hex); const hsv=hsvFromRgb(r,g,b); let h=hsv.h+(deg/360); h=(h%1+1)%1; const out=rgbFromHsv(h,Math.min(1,Math.max(0,hsv.s)),hsv.v); return rgbToHex(out.r,out.g,out.b) }
    function paletteFromHex(hex){ const comp=shiftHue(hex,180); const tri1=shiftHue(hex,120), tri2=shiftHue(hex,-120); const ana1=shiftHue(hex,30), ana2=shiftHue(hex,-30); return { comp, tri:[tri1,tri2], ana:[ana1,ana2] } }
    function generateIdeasOffline(hex, item){
      const pal=paletteFromHex(hex), out=[];
      out.push(`Combinar con complementario ${pal.comp} para alto contraste.`);
      out.push(`Paleta análoga: ${pal.ana[0]} + ${pal.ana[1]} para un look suave.`);
      out.push(`Triádica: ${pal.tri[0]} + ${pal.tri[1]} para acentos llamativos.`);
      if(item?.type?.toLowerCase().includes('pla')) out.push(`Temperatura sugerida: ${item.temp||'200–215°C'}.`);
      if(item?.style?.toLowerCase().includes('silk')) out.push(`Silk: reducí velocidad para mejorar el brillo.`);
      return out;
    }
    function renderIdeasList(item){
      const ul=document.getElementById('ideas-list');
      const box=document.getElementById('ideas-box');
      ul.innerHTML='';
      const list=(item.ideas && item.ideas.length)? item.ideas : generateIdeasOffline(item.hex, item);
      list.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li) });
      box.style.display='block';
    }

    /* ====== Filtro por tipo ====== */
    const TYPES=["Todos","PLA","PLA+","ABS","PETG","FLEX","PLAFLEX"]; // ← agrega aquí más si necesitás
    let selectedType="Todos";
    function normalizeType(s){ return (s||"").toString().trim().toUpperCase(); }
    function matchesType(item){ if(selectedType==="Todos") return true; return normalizeType(item.type)===normalizeType(selectedType); }
    function buildTypeMenu(){
      const btn=document.getElementById("type-filter-btn");
      const menu=document.getElementById("type-menu");
      menu.innerHTML="";
      TYPES.forEach(t=>{
        const opt=document.createElement("div");
        opt.className="type-opt"+(t===selectedType?" active":"");
        opt.textContent=t; opt.setAttribute("role","option");
        opt.onclick=()=>{ selectedType=t; [...menu.querySelectorAll(".type-opt")].forEach(x=>x.classList.toggle("active",x===opt));
          btn.textContent=`Tipo: ${t} ▾`; menu.classList.remove("open"); btn.setAttribute("aria-expanded","false");
          applySearch(document.getElementById("q").value||""); if(lastRGB) rankAndRenderBy(lastRGB);
        };
        menu.appendChild(opt);
      });
      btn.textContent=`Tipo: ${selectedType} ▾`;
      btn.onclick=(e)=>{ e.stopPropagation(); const open=!menu.classList.contains("open");
        document.querySelectorAll("#type-menu.open").forEach(m=>m.classList.remove("open"));
        menu.classList.toggle("open",open); btn.setAttribute("aria-expanded",open?"true":"false"); };
      document.addEventListener("click",(e)=>{ if(!menu.contains(e.target)&& e.target!==btn){ menu.classList.remove("open"); btn.setAttribute("aria-expanded","false"); } });
    }

    /* ====== Carga del Sheet ====== */
    async function cargar(){
      const el=document.getElementById('loading'); el.style.display='block';
      try{
        const res=await fetch(sheetUrl,{cache:'no-store',mode:'cors'}); let text=await res.text();
        text=text.replace(/^\uFEFF/,'').replace(/\r\n/g,'\n');
        const head=text.split('\n')[0]; const delim=head.includes('\t')?'\t':',';
        const rows=text.trim().split('\n').map(l=>l.split(delim));
        const headers=rows.shift().map(h=>h.replace(/^"(.*)"$/,'$1').trim().toLowerCase());
        const ix=k=>headers.indexOf(k);
        const idx={ id: ix('id'), name: ix('name'), hex: ix('hex'), brand: ix('brand'),
          type: ix('type'), style: ix('style'), temp: ix('temp'),
          strength: ix('strength'), link: ix('link'), img: ix('img'), ideas: ix('ideas') };
        items=[];
        rows.forEach(r=>{
          const hex=normalizeHex(r[idx.hex]||''); if(!hex) return;
          const obj={
            id: idx.id!==-1? norm(r[idx.id]) : '',
            name: norm(r[idx.name]),
            hex, rgb: hexToRgb(hex),
            brand: norm(r[idx.brand]),
            type: norm(r[idx.type]),
            style: norm(r[idx.style]),
            temp: norm(r[idx.temp]),
            strength: norm(r[idx.strength]),
            link: norm(r[idx.link]),
            img: norm(r[idx.img]),
            ideas: idx.ideas!==-1? parseIdeas(r[idx.ideas]) : []
          };
          if(!obj.id){
            const slug=(obj.name||'filamento').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
            obj.id=`${slug}-${hex.replace('#','')}`;
          }
          items.push(obj);
        });
        pool=items.slice();
      }catch(e){ console.error(e) }
      finally{ el.style.display='none' }
    }

    /* ====== Tarjeta y sugerencias ====== */
    function setSub(idPrefix, item){
      const sw=document.getElementById(`${idPrefix}-sw`);
      const nm=document.getElementById(`${idPrefix}-name`);
      const ds=document.getElementById(`${idPrefix}-desc`);
      const chip=document.getElementById(`${idPrefix}-chip`);
      const btn=document.getElementById(`${idPrefix}-btn`);
      if(!item){ sw.style.background='transparent'; nm.firstChild && (nm.firstChild.textContent='—'); ds.textContent='—'; btn.onclick=null; if(chip){chip.style.display='none';chip.textContent='';} return; }
      sw.style.background=item.hex;
      nm.innerHTML = `${item.name||'Sin nombre'} <span class="chip" id="${idPrefix}-chip">${item.type||'-'}</span>`;
      ds.textContent=`${item.brand||'-'} · ${item.type||'-'} · ${item.style||'-'}`;
      const theChip=document.getElementById(`${idPrefix}-chip`);
      if(theChip){ theChip.style.display=item.type?'inline-block':'none'; }
      btn.onclick=(e)=>{ e.preventDefault(); renderMainCard(item); if(item.img) openLightbox(item.img); };
    }
    function renderMainCard(a){
      if(!a) return; currentItem=a;
      document.getElementById('main-sw').style.background=a.hex;
      document.getElementById('main-name').textContent=a.name||'Sin nombre';
      document.getElementById('main-brand').textContent=a.brand||'-';
      document.getElementById('main-type').textContent=a.type||'-';
      document.getElementById('main-style').textContent=a.style||'-';
      document.getElementById('main-temp').textContent=a.temp||'-';
      document.getElementById('main-strength').textContent=a.strength||'-';
      document.getElementById('main-hex').textContent=a.hex;
      document.getElementById('main-link').href=a.link||'#';
      const prev=document.getElementById('preview-img');
      if(a.img){ prev.src=a.img; prev.style.display='block'; prev.onclick=()=>openLightbox(a.img); }
      else { prev.removeAttribute('src'); prev.style.display='none'; prev.onclick=null; }
      document.getElementById('ideas-box').style.display='none';
    }
    function colorDistance(a,b){ const dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b; return Math.sqrt(dr*dr+dg*dg+db*db) }
    function rankAndRenderBy(rgb){
      const base=items.filter(matchesType);
      if(!base.length) return;
      const ranked=base.map(it=>({it,d:colorDistance(rgb,it.rgb)})).sort((a,b)=>a.d-b.d).slice(0,3).map(x=>x.it);
      const [a,b,c]=ranked;
      if(a){ renderMainCard(a); }
      setSub('sub1', b);
      setSub('sub2', c);
      pool=base.slice();
    }

    /* ====== Lightbox ====== */
    const lb=document.getElementById('lightbox'); const lbImg=document.getElementById('lb-img');
    function openLightbox(src){ if(!src) return; lbImg.src=src; lb.classList.add('open'); requestAnimationFrame(()=>lb.classList.add('show')); }
    function closeLightbox(){ lb.classList.remove('show'); setTimeout(()=>{ if(!lb.classList.contains('show')){ lb.classList.remove('open'); lbImg.removeAttribute('src'); } },220); }
    document.getElementById('lb-close').addEventListener('click', closeLightbox);
    lb.addEventListener('click', e=>{ if(e.target.id==='lightbox') closeLightbox(); });
    lbImg.addEventListener('click', e=>e.stopPropagation());
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeLightbox(); });

    /* ====== Buscador ====== */
    const inputQ=document.getElementById('q'); const sugsBox=document.getElementById('sugs');
    function hideSugs(){ sugsBox.style.display='none'; sugsBox.innerHTML=''; }
    function showSugs(){ sugsBox.style.display='block'; }
    function renderSugs(list){
      sugsBox.innerHTML=''; if(!list.length){ hideSugs(); return; }
      list.slice(0,80).forEach(it=>{
        const div=document.createElement('div'); div.className='sug-item';
        const dot=document.createElement('span'); dot.className='sug-dot'; dot.style.background=it.hex;
        const text=document.createElement('div'); text.innerHTML=`<strong>${it.name||'(Sin nombre)'}</strong><div class="sug-meta">${it.brand||'-'} · ${it.hex}</div>`;
        const go=document.createElement('div'); go.textContent='ver'; go.style.fontSize='12px'; go.style.color='var(--accent)';
        div.append(dot,text,go);
        div.onclick=()=>{ hideSugs(); inputQ.value=it.name||it.hex; renderMainCard(it); setSub('sub1', null); setSub('sub2', null); };
        sugsBox.appendChild(div);
      });
      showSugs();
    }
    function applySearch(q){
      q=(q||"").trim().toLowerCase();
      const base=items.filter(matchesType);
      if(!q){ hideSugs(); pool=base.slice(); return; }
      if(q.startsWith('#')){ const hx=normalizeHex(q)||''; pool=base.filter(it=>it.hex.startsWith(hx)); }
      else { pool=base.filter(it=>(it.name||'').toLowerCase().includes(q) || (it.brand||'').toLowerCase().includes(q)); }
      renderSugs(pool);
    }
    inputQ.addEventListener('input', e=>{
      const menu=document.getElementById("type-menu"); const btn=document.getElementById("type-filter-btn");
      menu.classList.remove("open"); btn.setAttribute("aria-expanded","false");
      applySearch(e.target.value);
    });
    inputQ.addEventListener('focus', ()=>{ if(inputQ.value) applySearch(inputQ.value) });
    document.addEventListener('click', e=>{ if(!sugsBox.contains(e.target) && e.target!==inputQ) hideSugs(); });

    /* ====== Picker circular ====== */
    const wheel = document.getElementById('wheel');
    const wctx = wheel.getContext('2d', { willReadFrequently:true });
    const wheelCursor = document.getElementById('wheel-cursor');

    const vbar = document.getElementById('vbar');
    const vctx = vbar.getContext('2d');
    const vCursor = document.getElementById('v-cursor');

    const hexInput = document.getElementById('hex');
    const rInput = document.getElementById('r');
    const gInput = document.getElementById('g');
    const bInput = document.getElementById('b');
    const eyedrop = document.getElementById('eyedrop');

    const CX = wheel.width/2, CY = wheel.height/2, R = wheel.width/2 - 2;
    let H=0, S=1, V=1;
    let draggingWheel=false, draggingV=false;

    function drawWheel(){
      const img = wctx.createImageData(wheel.width, wheel.height);
      for(let y=0; y<wheel.height; y++){
        for(let x=0; x<wheel.width; x++){
          const dx = x - CX, dy = y - CY;
          const dist = Math.sqrt(dx*dx + dy*dy);
          if (dist <= R){
            let angle = Math.atan2(dy, dx);
            if (angle < 0) angle += Math.PI*2;
            const hue = angle / (Math.PI*2);
            const sat = dist / R;
            const {r,g,b} = rgbFromHsv(hue, sat, 1); // dibujamos con V=1
            const idx = (y*wheel.width + x) * 4;
            img.data[idx] = r;
            img.data[idx+1] = g;
            img.data[idx+2] = b;
            img.data[idx+3] = 255;
          }
        }
      }
      wctx.putImageData(img,0,0);
    }
    function drawVbar(){
      const w=vbar.width, h=vbar.height;
      const grad=vctx.createLinearGradient(0,0,w,0);
      grad.addColorStop(0, 'black');
      grad.addColorStop(1, 'white');
      vctx.fillStyle=grad; vctx.fillRect(0,0,w,h);
    }
    function updateCursorsFromHSV(){
      const angle = H * Math.PI*2;
      const r = S * R;
      const x = CX + r * Math.cos(angle);
      const y = CY + r * Math.sin(angle);
      wheelCursor.style.left = x + 'px';
      wheelCursor.style.top  = y + 'px';

      const xv = V * vbar.width;
      vCursor.style.left = xv + 'px';
    }
    function emitColorFromHSV(){
      const {r,g,b} = rgbFromHsv(H,S,V);
      const hex = rgbToHex(r,g,b);
      lastRGB = {r,g,b};
      document.getElementById('sel-rgb').textContent = `${r}, ${g}, ${b}`;
      document.getElementById('sel-hex').textContent = hex;
      document.getElementById('sel-sw').style.background = hex;
      if (hexInput.value.toLowerCase()!==hex) hexInput.value = hex;
      if (+rInput.value!==r) rInput.value = r;
      if (+gInput.value!==g) gInput.value = g;
      if (+bInput.value!==b) bInput.value = b;
      rankAndRenderBy({r,g,b});
    }
    function pickWheel(clientX, clientY){
      const rect = wheel.getBoundingClientRect();
      const scaleX = wheel.width / rect.width;
      const scaleY = wheel.height / rect.height;
      const x = (clientX - rect.left) * scaleX;
      const y = (clientY - rect.top) * scaleY;
      const dx = x - CX, dy = y - CY;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist>R) return;
      let angle = Math.atan2(dy, dx);
      if (angle < 0) angle += Math.PI*2;
      H = angle / (Math.PI*2);
      S = dist / R;
      updateCursorsFromHSV();
      emitColorFromHSV();
    }
    function pickV(clientX){
      const rect = vbar.getBoundingClientRect();
      const x = clamp((clientX - rect.left) * (vbar.width/rect.width), 0, vbar.width);
      V = x / vbar.width;
      updateCursorsFromHSV();
      emitColorFromHSV();
    }

    wheel.addEventListener('mousedown', e=>{ draggingWheel=true; pickWheel(e.clientX,e.clientY); });
    window.addEventListener('mousemove', e=>{ if(draggingWheel) pickWheel(e.clientX,e.clientY); if(draggingV) pickV(e.clientX); });
    window.addEventListener('mouseup', ()=>{ draggingWheel=false; draggingV=false; });
    wheel.addEventListener('touchstart', e=>{ const p=e.touches[0]; draggingWheel=true; pickWheel(p.clientX,p.clientY); }, {passive:false});
    window.addEventListener('touchmove', e=>{ if(draggingWheel){ const p=e.touches[0]; pickWheel(p.clientX,p.clientY); } if(draggingV){ const p=e.touches[0]; pickV(p.clientX); } }, {passive:false});
    window.addEventListener('touchend', ()=>{ draggingWheel=false; draggingV=false; });

    vbar.addEventListener('mousedown', e=>{ draggingV=true; pickV(e.clientX); });
    vbar.addEventListener('touchstart', e=>{ const p=e.touches[0]; draggingV=true; pickV(p.clientX); }, {passive:false});

    // inputs manuales
    function setFromHexInput(){
      const hx=normalizeHex(hexInput.value||''); if(!hx) return;
      const {r,g,b}=hexToRgb(hx); const hsv=hsvFromRgb(r,g,b);
      H=hsv.h; S=hsv.s; V=hsv.v; updateCursorsFromHSV(); emitColorFromHSV();
    }
    hexInput.addEventListener('input', setFromHexInput);
    function setFromRgbInputs(){
      let r=clamp(parseInt(rInput.value||0,10),0,255);
      let g=clamp(parseInt(gInput.value||0,10),0,255);
      let b=clamp(parseInt(bInput.value||0,10),0,255);
      const hsv=hsvFromRgb(r,g,b);
      H=hsv.h; S=hsv.s; V=hsv.v; updateCursorsFromHSV(); emitColorFromHSV();
    }
    [rInput,gInput,bInput].forEach(el=>el.addEventListener('input', setFromRgbInputs));

    // cuentagotas (EyeDropper API)
    if (!('EyeDropper' in window)) {
      eyedrop.disabled = true;
      eyedrop.title = "Cuentagotas no soportado por este navegador";
    }
    eyedrop.addEventListener('click', async ()=>{
      if(!('EyeDropper' in window)) return;
      try{
        const ed=new window.EyeDropper();
        const res=await ed.open();
        if(res?.sRGBHex){
          hexInput.value=res.sRGBHex;
          setFromHexInput();
        }
      }catch(e){ /* cancelado */ }
    });

    /* ====== Inicio ====== */
    const lbClose=document.getElementById('lb-close');
    async function init(){
      // reset
      selectedType="Todos"; document.getElementById('type-filter-btn').textContent="Tipo: Todos ▾";
      document.getElementById('q').value=""; document.getElementById('ideas-box').style.display='none';

      buildTypeMenu();
      await cargar();

      drawWheel(); drawVbar();
      H=0; S=1; V=1; updateCursorsFromHSV(); emitColorFromHSV(); // rojo puro

      document.getElementById('ideas-show').addEventListener('click', ()=>{ if(currentItem) renderIdeasList(currentItem); });
      document.getElementById('ideas-refresh').addEventListener('click', ()=>{ if(currentItem) renderIdeasList(currentItem); });
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
