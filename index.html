<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hoho3D – Búsqueda por color</title>
<style>
  :root{ --bg:#0b0c0f; --card:#111317; --muted:#9aa1ac; --text:#e8ecf1; --accent:#3b82f6; --line:#1b1f28; }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,"Noto Sans",sans-serif; color:var(--text); background:linear-gradient(120deg,#0b0c0f,#0f1218); }
  header{ padding:12px 20px; border-bottom:1px solid var(--line); position:sticky; top:0; background:#0b0c0fd9; backdrop-filter:saturate(140%) blur(6px); display:flex; gap:12px; align-items:center; z-index:5 }
  header h1{ margin:0; font-size:16px; font-weight:600; letter-spacing:.2px; white-space:nowrap }
  .searchline{ margin-left:auto; display:flex; align-items:center; gap:8px; position:relative }
  .input{ width:420px; max-width:55vw; padding:8px 10px; border-radius:10px; border:1px solid #223047; background:#131824; color:#dbe6f7; font-size:14px }
  .suggestions{ position:absolute; top:42px; left:0; width:420px; max-width:55vw; max-height:320px; overflow:auto; background:var(--card); border:1px solid var(--line); border-radius:10px; padding:6px; display:none; z-index:10 }
  .sug-item{ display:grid; grid-template-columns: 20px 1fr auto; gap:10px; align-items:center; padding:8px; border-radius:8px; cursor:pointer }
  .sug-item:hover{ background:#0f1218 }
  .sug-dot{ width:20px; height:20px; border-radius:6px; border:1px solid var(--line) }
  .sug-meta{ color:var(--muted); font-size:12px }

  .filter-wrap{ position:relative }
  .btn{ appearance:none; border:1px solid #223047; background:#131824; color:#dbe6f7; padding:8px 10px; border-radius:10px; font-size:14px; cursor:pointer }
  .btn:hover{ border-color:#2b3a55 }
  .filter-menu{ position:absolute; right:0; top:44px; background:var(--card); border:1px solid var(--line); border-radius:12px; padding:6px; width:220px; display:none; z-index:11 }
  .filter-item{ display:flex; align-items:center; gap:8px; padding:8px; border-radius:8px; cursor:pointer; color:#dbe6f7 }
  .filter-item:hover{ background:#0f1218 }
  .filter-item.active{ outline:1px dashed var(--accent) }

  .app{ display:grid; grid-template-columns: 420px minmax(420px, 620px); gap:20px; padding:20px; max-width:1200px; margin:0 auto; align-items:start }

  /* Panel izquierdo */
  .left{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px }
  #loading{ display:none; font-size:14px; color:var(--muted); margin-bottom:8px }

  .picker{ display:flex; align-items:center; gap:12px; user-select:none }
  .vbar-wrap{ display:flex; flex-direction:column; align-items:center; gap:8px }
  #vbar{ width:22px; height:245px; border-radius:6px; border:1px solid var(--line); cursor:ns-resize; display:block }
  .eyedrop{ display:flex; flex-direction:column; align-items:center; gap:6px; margin-top:4px }
  .btn-mini{ padding:6px 10px; font-size:12px }
  .syringe{ width:16px; height:16px; display:block }
  #wheel{ width:220px; height:220px; border-radius:50%; border:1px solid var(--line); cursor:crosshair; display:block }

  .current{ display:flex; gap:8px; align-items:center; font-size:14px; color:var(--muted); margin:10px 0 6px; flex-wrap:wrap }
  .current .sw{ width:20px; height:20px; border-radius:6px; border:1px solid var(--line) }
  .hex-input{ width:120px; padding:6px 8px; border-radius:8px; border:1px solid #223047; background:#0f1218; color:#dbe6f7; font-size:14px }
  .preview-img{ width:100%; max-width:380px; height:220px; object-fit:cover; border-radius:12px; border:1px solid var(--line); display:block; margin:10px auto 0; transition:transform .25s ease }

  /* Panel derecho */
  .right{ display:grid; gap:14px }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px }
  .card h2{ margin:0 0 6px 0; font-size:18px }
  .meta{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:14px; color:var(--muted) }
  .meta div strong{ color:var(--text); font-weight:600 }
  .main-sw{ width:100%; height:110px; border-radius:10px; border:1px solid var(--line); margin-bottom:10px }
  .actions{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap }

  .subs{ display:grid; gap:10px }
  .sub{ display:grid; grid-template-columns: 54px 1fr auto; gap:10px; align-items:center; padding:10px; border:1px solid var(--line); border-radius:12px; background:#0f1218 }
  .sub .sw{ width:54px; height:44px; border-radius:8px; border:1px solid var(--line) }
  .sub h3{ margin:0; font-size:15px }
  .sub small{ color:var(--muted) }
  .sub .btn-mini{ padding:6px 10px; font-size:13px }

  /* Lightbox con fade + zoom */
  .lightbox { position:fixed; inset:0; background:rgba(0,0,0,.75); display:none; align-items:center; justify-content:center; z-index:9999; opacity:0; transition:opacity .18s ease }
  .lightbox.show{ display:flex; opacity:1 }
  .lightbox img { max-width:min(92vw,1200px); max-height:90vh; display:block; transform:scale(.98); transition:transform .18s ease }
  .lightbox.show img{ transform:scale(1) }
  .lightbox .close { position:absolute; top:12px; right:12px; padding:8px 10px; border:0; border-radius:8px; background:#fff; color:#111; cursor:pointer; z-index:2; }

  /* Ideas box */
  .ideas{ background:#0f1218; border:1px dashed #243148; border-radius:10px; padding:10px; margin-top:10px; display:none }
  .ideas ul{ margin:8px 0 0 16px }
  .tiny-note{ font-size:12px; color:var(--muted); text-align:center; max-width:180px }
  .file-mini{ width:180px; font-size:12px }
</style>
</head>
<body>
  <header>
    <h1>Hoho3D · Búsqueda por color</h1>

    <div class="searchline" role="search">
      <input id="q" class="input" type="search" placeholder="Buscar por color, marca o #hex exacto" autocomplete="off" />
      <!-- Filtro por tipo -->
      <div class="filter-wrap">
        <button id="filterBtn" class="btn" type="button">Tipo: <span id="filterLabel">All</span></button>
        <div id="filterMenu" class="filter-menu" role="menu" aria-label="Filtrar por tipo">
          <!-- Para agregar más tipos, duplicá una .filter-item y cambiá data-type -->
          <div class="filter-item active" data-type="all">All</div>
          <div class="filter-item" data-type="pla">PLA</div>
          <div class="filter-item" data-type="pla+">PLA+</div>
          <div class="filter-item" data-type="abs">ABS</div>
          <div class="filter-item" data-type="petg">PETG</div>
          <div class="filter-item" data-type="flex">FLEX</div>
          <div class="filter-item" data-type="plaflex">PLAFLEX</div>
        </div>
      </div>

      <div id="sugs" class="suggestions" role="listbox" aria-label="Resultados de búsqueda"></div>
    </div>
  </header>

  <main class="app">
    <section class="left">
      <div id="loading">Cargando catálogo...</div>

      <!-- Selector: barra V (no altera la rueda visual) + rueda HSV pequeña -->
      <div class="picker">
        <div class="vbar-wrap">
          <canvas id="vbar" width="22" height="245" aria-label="Brillo (V)"></canvas>
          <div class="eyedrop">
            <!-- Ícono jeringa (sin emoji) -->
            <svg class="syringe" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="#dbe6f7" d="M21 3l-1 1-1-1-2 2 1 1-9 9-2-2-2 2 2 2-3 3 1 1 3-3 2 2 2-2-2-2 9-9 1 1 2-2-1-1 1-1z"/>
            </svg>
            <button id="eyedropBtn" class="btn btn-mini" type="button" title="Tomar color de la pantalla">Cuentagotas</button>
            <!-- Cargador de imagen de referencia -->
            <input id="imgRef" class="file-mini" type="file" accept="image/*" />
            <div class="tiny-note">Usa una imagen de referencia (toma el color predominante)</div>
          </div>
        </div>
        <canvas id="wheel" width="220" height="220" aria-label="Rueda de color HSV"></canvas>
      </div>

      <div class="current">
        <div class="sw" id="sel-sw"></div>
        <div><strong>RGB:</strong> <span id="sel-rgb">—</span></div>
        <div><strong>HEX:</strong> <input id="sel-hex-input" class="hex-input" placeholder="#rrggbb" /></div>
      </div>

      <img id="preview-img" class="preview-img" alt="Vista previa de filamento" />
    </section>

    <section class="right">
      <article class="card" id="main-card" aria-live="polite">
        <div class="main-sw" id="main-sw"></div>
        <h2 id="main-name">—</h2>
        <div class="meta">
          <div><strong>Marca:</strong> <span id="main-brand">—</span></div>
          <div><strong>Tipo:</strong> <span id="main-type">—</span></div>
          <div><strong>Estilo:</strong> <span id="main-style">—</span></div>
          <div><strong>Temp.:</strong> <span id="main-temp">—</span></div>
          <div><strong>Resist.:</strong> <span id="main-strength">—</span></div>
          <div><strong>HEX:</strong> <span id="main-hex">—</span></div>
        </div>
        <div class="actions">
          <a id="main-link" class="btn" href="#" target="_blank" rel="noopener">Abrir en tienda</a>
          <button id="ideasBtn" class="btn" type="button">Creador de Ideas</button>
        </div>
        <div id="ideasBox" class="ideas"></div>
      </article>

      <article class="card">
        <h2 style="margin-bottom:8px">Otras sugerencias</h2>
        <div class="subs">
          <div class="sub" id="sub-1">
            <div class="sw" id="sub1-sw"></div>
            <div>
              <h3 id="sub1-name">—</h3>
              <small id="sub1-desc">—</small>
            </div>
            <button class="btn btn-mini" id="sub1-btn">Ver</button>
          </div>
          <div class="sub" id="sub-2">
            <div class="sw" id="sub2-sw"></div>
            <div>
              <h3 id="sub2-name">—</h3>
              <small id="sub2-desc">—</small>
            </div>
            <button class="btn btn-mini" id="sub2-btn">Ver</button>
          </div>
        </div>
      </article>
    </section>
  </main>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox">
    <button class="close" id="lb-close">Cerrar</button>
    <img id="lb-img" alt="Imagen del filamento" />
  </div>

<script>
/* ======================= Config ======================= */
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ-GFIahnmzB09C1GWCvAs1PaNXmpN2_Ed5taWtseTRlqx0P8-ZKJ28TOsvziFOw/pub?output=tsv";

/* ======================= Utils ======================= */
const clamp = (n,a,b)=>Math.min(b,Math.max(a,n));
const norm = s => (s==null? '' : String(s).trim());
function normalizeHex(h){
  if (typeof h !== 'string') return null;
  const s = h.trim();
  const r3 = /^#?[0-9a-fA-F]{3}$/; const r6 = /^#?[0-9a-fA-F]{6}$/;
  if (r3.test(s)){ const p=s.replace('#',''); return '#'+p.split('').map(c=>c+c).join('').toLowerCase(); }
  if (r6.test(s)){ return '#'+s.replace('#','').toLowerCase(); }
  return null;
}
function hexToRgb(hex){ const h=(hex||'').replace('#',''); if(h.length!==6) return {r:0,g:0,b:0}; return { r:parseInt(h.slice(0,2),16), g:parseInt(h.slice(2,4),16), b:parseInt(h.slice(4,6),16) }; }
function rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>clamp(Math.round(v),0,255).toString(16).padStart(2,'0')).join(''); }
function rgbFromHsv(h, s, v){
  h = Number(h); s = Number(s); v = Number(v);
  if (s === 0) { const g=Math.round(v*255); return {r:g,g:g,b:g}; }
  let i = Math.floor(h * 6);
  const f = h * 6 - i;
  const p = v * (1 - s);
  const q = v * (1 - s * f);
  const t = v * (1 - s * (1 - f));
  i = i % 6;
  let r,g,b;
  if (i===0){ r=v; g=t; b=p; }
  else if(i===1){ r=q; g=v; b=p; }
  else if(i===2){ r=p; g=v; b=t; }
  else if(i===3){ r=p; g=q; b=v; }
  else if(i===4){ r=t; g=p; b=v; }
  else { r=v; g=p; b=q; }
  return { r: Math.round(r*255), g: Math.round(g*255), b: Math.round(b*255) };
}
function colorDistance(a,b){ const dr=a.r-b.r, dg=a.g-b.g, db=a.b-b.b; return Math.sqrt(dr*dr+dg*dg+db*db); }

/* ======================= Estado ======================= */
let items = [], pool = [], lastRGB = null, draggingWheel=false, draggingV=false;
let filterType = 'all'; // all | pla | pla+ | abs | petg | flex | plaflex
let V = 1; // brillo 0..1

/* ======================= Picker (rueda + barra V) ======================= */
const wheel = document.getElementById('wheel');
const wctx = wheel.getContext('2d', { willReadFrequently:true });
const VBAR = document.getElementById('vbar');
const vctx = VBAR.getContext('2d');

const W = wheel.width, H = wheel.height;
const CX = W/2, CY = H/2, R = Math.min(W,H)/2 - 2;

function drawVBar(){
  const img = vctx.createImageData(VBAR.width, VBAR.height);
  for (let y=0; y<VBAR.height; y++){
    const vv = 1 - (y/(VBAR.height-1));
    const g = Math.round(vv*255);
    for (let x=0; x<VBAR.width; x++){
      const i = (y*VBAR.width + x)*4;
      img.data[i]=g; img.data[i+1]=g; img.data[i+2]=g; img.data[i+3]=255;
    }
  }
  vctx.putImageData(img,0,0);
  const y = (1 - V) * (VBAR.height-1);
  vctx.fillStyle = "#3b82f6";
  vctx.fillRect(0, y-1, VBAR.width, 2);
}

function drawWheel(){
  // IMPORTANTE: la rueda se dibuja SIEMPRE con v=1 para no “parpadear”
  const img = wctx.createImageData(W, H);
  for (let y=0; y<H; y++){
    for (let x=0; x<W; x++){
      const dx=x-CX, dy=y-CY, d=Math.sqrt(dx*dx+dy*dy);
      const idx = (y*W+x)*4;
      if (d<=R){
        let ang=Math.atan2(dy,dx); if(ang<0) ang+=Math.PI*2;
        const hue = ang/(Math.PI*2);
        const sat = d/R;
        const {r,g,b} = rgbFromHsv(hue, sat, 1); // v=1 fijo
        img.data[idx]=r; img.data[idx+1]=g; img.data[idx+2]=b; img.data[idx+3]=255;
      } else {
        img.data[idx+3]=0;
      }
    }
  }
  wctx.putImageData(img,0,0);
}

function setSelectionFromRGB(rgb){
  lastRGB = rgb;
  const hex = rgbToHex(rgb.r, rgb.g, rgb.b);
  document.getElementById('sel-rgb').textContent = `${rgb.r}, ${rgb.g}, ${rgb.b}`;
  hexInput.value = hex;
  document.getElementById('sel-sw').style.background = hex;
  rankAndRenderBy(rgb);
}

function pickFromWheel(clientX, clientY){
  const rect = wheel.getBoundingClientRect();
  const scaleX = W / rect.width;
  const scaleY = H / rect.height;
  const x = (clientX - rect.left) * scaleX;
  const y = (clientY - rect.top) * scaleY;
  const dx = x - CX, dy = y - CY; const dist = Math.sqrt(dx*dx+dy*dy);
  if (dist>R) return;
  let ang = Math.atan2(dy, dx); if (ang<0) ang += Math.PI*2;
  const hue = ang/(Math.PI*2), sat = dist/R;
  const rgb = rgbFromHsv(hue, sat, V); // ahora sí usa V, pero solo para la selección
  setSelectionFromRGB(rgb);
}

function pickFromVBar(clientY){
  const rect = VBAR.getBoundingClientRect();
  const scaleY = VBAR.height / rect.height;
  let y = (clientY - rect.top) * scaleY;
  y = clamp(y, 0, VBAR.height-1);
  V = 1 - (y/(VBAR.height-1));
  drawVBar();
  // NO redibujo la rueda (se mantiene visualmente fija). Si ya hay color, recalculo con el mismo H/S no lo conocemos aquí,
  // por simplicidad solo re-rankeamos si el usuario vuelve a tocar la rueda o edita HEX.
}

/* Eventos rueda/barra */
wheel.addEventListener('mousedown', e=>{ draggingWheel=true; pickFromWheel(e.clientX,e.clientY); });
window.addEventListener('mousemove', e=>{ if(draggingWheel) pickFromWheel(e.clientX,e.clientY); });
window.addEventListener('mouseup', ()=> draggingWheel=false);
wheel.addEventListener('touchstart', e=>{ draggingWheel=true; const t=e.touches[0]; pickFromWheel(t.clientX,t.clientY); }, {passive:false});
window.addEventListener('touchmove', e=>{ if(!draggingWheel) return; const t=e.touches[0]; pickFromWheel(t.clientX,t.clientY); }, {passive:false});
window.addEventListener('touchend', ()=> draggingWheel=false);

VBAR.addEventListener('mousedown', e=>{ draggingV=true; pickFromVBar(e.clientY); });
window.addEventListener('mousemove', e=>{ if(draggingV) pickFromVBar(e.clientY); });
window.addEventListener('mouseup', ()=> draggingV=false);
VBAR.addEventListener('touchstart', e=>{ draggingV=true; const t=e.touches[0]; pickFromVBar(t.clientY); }, {passive:false});
window.addEventListener('touchmove', e=>{ if(!draggingV) return; const t=e.touches[0]; pickFromVBar(t.clientY); }, {passive:false});
window.addEventListener('touchend', ()=> draggingV=false);

/* Cuentagotas (EyeDropper API) */
document.getElementById('eyedropBtn').addEventListener('click', async ()=>{
  if (!('EyeDropper' in window)){
    alert('Tu navegador no soporta el cuentagotas nativo.');
    return;
  }
  try{
    const ed = new EyeDropper();
    const res = await ed.open();
    const hex = res.sRGBHex.toLowerCase();
    const rgb = hexToRgb(hex);
    setSelectionFromRGB(rgb);
  }catch(e){ /* cancelado */ }
});

/* Imagen de referencia: color predominante (rápido por histogramado 4 bits) */
document.getElementById('imgRef').addEventListener('change', (e)=>{
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  const img = new Image();
  img.onload = ()=>{
    const cw = 64, ch = 64;
    const c = document.createElement('canvas');
    c.width = cw; c.height = ch;
    const ctx = c.getContext('2d', { willReadFrequently:true });
    ctx.drawImage(img, 0, 0, cw, ch);
    const data = ctx.getImageData(0,0,cw,ch).data;
    const buckets = new Map();
    for (let i=0; i<data.length; i+=4){
      const r = data[i], g=data[i+1], b=data[i+2], a=data[i+3];
      if (a < 128) continue;
      // cuantización 4 bits por canal
      const rk = r>>4, gk=g>>4, bk=b>>4;
      const key = (rk<<8) | (gk<<4) | bk;
      buckets.set(key, (buckets.get(key)||0)+1);
    }
    let bestKey = null, bestCount = -1;
    for (const [k,v] of buckets.entries()){ if (v>bestCount){ bestCount=v; bestKey=k; } }
    if (bestKey==null) return;
    const rk=(bestKey>>8)&0xF, gk=(bestKey>>4)&0xF, bk=bestKey&0xF;
    const rgb = { r: (rk<<4)+8, g: (gk<<4)+8, b: (bk<<4)+8 };
    setSelectionFromRGB(rgb);
  };
  const url = URL.createObjectURL(file);
  img.src = url;
});

/* ======================= Carga hoja ======================= */
let filterTypeEl = null;
async function cargar(){
  const el = document.getElementById('loading'); el.style.display='block';
  try{
    const res = await fetch(sheetUrl, {cache:'no-store', mode:'cors'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    let text = await res.text();
    if(/<\s*html/i.test(text)) throw new Error('La URL devolvió HTML. Publica como TSV/CSV');
    text = text.replace(/^\uFEFF/, '').replace(/\r\n/g,'\n');
    const headLine = text.split('\n')[0];
    const delim = headLine.includes('\t') ? '\t' : ',';
    const rows = text.trim().split('\n').map(l=>l.split(delim));
    const headers = rows.shift().map(h=>h.replace(/^"(.*)"$/,'$1').toLowerCase().trim());
    const ix = k => headers.indexOf(k);
    const idx = {
      id: headers.includes('id')? ix('id') : -1,
      name: headers.includes('name')? ix('name') : ix('nombre'),
      hex: ix('hex'),
      brand: headers.includes('brand')? ix('brand'): ix('marca'),
      type: headers.includes('type')? ix('type'): ix('tipo'),
      style: headers.includes('style')? ix('style'): ix('estilo'),
      temp: headers.includes('temp')? ix('temp'): ix('temperatura'),
      strength: headers.includes('strength')? ix('strength'): ix('resistencia'),
      link: headers.includes('link')? ix('link'): ix('url'),
      img: headers.includes('img')? ix('img'): (headers.includes('image')? ix('image'): (headers.includes('foto')? ix('foto') : -1)),
      ideas: headers.includes('ideas')? ix('ideas'): -1
    };
    if (idx.hex === -1) throw new Error('Falta columna HEX');

    items = [];
    rows.forEach(r=>{
      const hex = normalizeHex(r[idx.hex]||''); if(!hex) return;
      const it = {
        id: idx.id!==-1? norm(r[idx.id]) : '',
        name: idx.name!==-1? norm(r[idx.name]) : '',
        brand: idx.brand!==-1? norm(r[idx.brand]) : '',
        type: idx.type!==-1? norm(r[idx.type]) : '',
        style: idx.style!==-1? norm(r[idx.style]) : '',
        temp: idx.temp!==-1? norm(r[idx.temp]) : '',
        strength: idx.strength!==-1? norm(r[idx.strength]) : '',
        link: idx.link!==-1? norm(r[idx.link]) : '#',
        img: idx.img!==-1? norm(r[idx.img]) : '',
        ideasRaw: idx.ideas!==-1? norm(r[idx.ideas]) : '',
        hex,
        rgb: hexToRgb(hex)
      };
      items.push(it);
    });
    applyFilters();
  }catch(e){
    console.error(e);
    alert('Error al cargar hoja: ' + e.message);
  }finally{ el.style.display='none'; }
}

/* ======================= Búsqueda + Filtro ======================= */
const inputQ = document.getElementById('q');
const sugsBox = document.getElementById('sugs');
function hideSugs(){ sugsBox.style.display='none'; sugsBox.innerHTML=''; }
function showSugs(){ sugsBox.style.display='block'; }
function renderSugs(list){
  sugsBox.innerHTML = '';
  const out = list.slice(0, 100);
  if (!out.length){ hideSugs(); return; }
  out.forEach(it=>{
    const div = document.createElement('div');
    div.className='sug-item';
    const dot = document.createElement('span'); dot.className='sug-dot'; dot.style.background = it.hex;
    const text = document.createElement('div');
    text.innerHTML = `<strong>${it.name || '(Sin nombre)'}</strong><div class="sug-meta">${it.brand || '-'} · ${it.hex}</div>`;
    const go = document.createElement('div'); go.textContent = 'ver'; go.style.fontSize='12px'; go.style.color='var(--accent)';
    div.appendChild(dot); div.appendChild(text); div.appendChild(go);
    div.onclick = ()=>{
      hideSugs();
      inputQ.value = it.name || it.hex;
      setSelectionFromRGB(it.rgb);
      renderMainCard(it);
    };
    sugsBox.appendChild(div);
  });
  showSugs();
}
function applyFilters(){
  const q = (inputQ.value||'').trim().toLowerCase();
  let base = items.filter(it=>{
    if (filterType!=='all'){
      if ((it.type||'').toLowerCase() !== filterType) return false;
    }
    return true;
  });
  if (!q){ pool = base; hideSugs(); return; }
  if (q.startsWith('#')){
    const hx = normalizeHex(q) || '';
    pool = base.filter(it => it.hex.startsWith(hx));
  } else {
    pool = base.filter(it =>
      (it.name||'').toLowerCase().includes(q) ||
      (it.brand||'').toLowerCase().includes(q)
    );
  }
  renderSugs(pool);
  if (lastRGB) rankAndRenderBy(lastRGB);
}
const filterBtn = document.getElementById('filterBtn');
const filterLabel = document.getElementById('filterLabel');
const filterMenu = document.getElementById('filterMenu');
filterBtn.addEventListener('click', ()=>{
  const showed = filterMenu.style.display==='block';
  filterMenu.style.display = showed? 'none':'block';
});
document.addEventListener('click', (e)=>{
  if (!filterMenu.contains(e.target) && e.target!==filterBtn) filterMenu.style.display='none';
});
Array.from(filterMenu.querySelectorAll('.filter-item')).forEach(el=>{
  el.addEventListener('click', ()=>{
    Array.from(filterMenu.querySelectorAll('.filter-item')).forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    filterType = el.dataset.type;
    filterLabel.textContent = el.textContent.trim();
    filterMenu.style.display='none';
    applyFilters();
  });
});
inputQ.addEventListener('input', ()=>{ filterMenu.style.display='none'; applyFilters(); });
inputQ.addEventListener('focus', ()=>{ if (inputQ.value) renderSugs(pool); });
document.addEventListener('click', (e)=>{ if (!sugsBox.contains(e.target) && e.target!==inputQ) hideSugs(); });

/* ======================= Ranking y tarjetas ======================= */
function rankAndRenderBy(rgb){
  if (!pool.length) return;
  const ranked = pool.map(it=>({it, d: colorDistance(rgb, it.rgb)})).sort((a,b)=>a.d-b.d).slice(0,3).map(x=>x.it);
  renderSide(ranked);
}
function renderMainCard(a){
  document.getElementById('main-sw').style.background = a.hex;
  document.getElementById('main-name').textContent = a.name || 'Sin nombre';
  document.getElementById('main-brand').textContent = a.brand || '-';
  document.getElementById('main-type').textContent = a.type || '-';
  document.getElementById('main-style').textContent = a.style || '-';
  document.getElementById('main-temp').textContent = a.temp || '-';
  document.getElementById('main-strength').textContent = a.strength || '-';
  document.getElementById('main-hex').textContent = a.hex;
  document.getElementById('main-link').href = a.link || '#';

  const prev = document.getElementById('preview-img');
  if (a.img){
    prev.src = a.img; prev.alt = `Vista previa ${a.name}`; prev.style.visibility='visible';
    prev.onerror = ()=>{ prev.removeAttribute('src'); prev.style.visibility='hidden'; };
    prev.onclick = ()=>{ openLightbox(a.img); };
  } else {
    prev.removeAttribute('src'); prev.alt='Sin vista previa'; prev.style.visibility='hidden';
    prev.onclick = null;
  }

  const ideasBox = document.getElementById('ideasBox');
  ideasBox.style.display='none';
  ideasBox.innerHTML = '';
  document.getElementById('ideasBtn').onclick = ()=>{
    const ideas = (a.ideasRaw || '').split(/[\|,]/).map(s=>s.trim()).filter(Boolean);
    if (!ideas.length){
      ideasBox.innerHTML = '<em style="color:var(--muted)">Sin ideas pre-cargadas para este filamento.</em>';
    } else {
      const ul = document.createElement('ul');
      ideas.forEach(i=>{ const li=document.createElement('li'); li.textContent=i; ul.appendChild(li); });
      ideasBox.innerHTML = '<strong>Ideas</strong>';
      ideasBox.appendChild(ul);
    }
    ideasBox.style.display='block';
  };
}
function renderSide(top){
  const [a,b,c] = top;
  if (!a) return;
  renderMainCard(a);
  const setSub = (sub, item) => {
    const sw = document.getElementById(sub+'-sw');
    const nm = document.getElementById(sub+'-name');
    const ds = document.getElementById(sub+'-desc');
    const btn = document.getElementById(sub+'-btn');
    if (!item){ sw.style.background='transparent'; nm.textContent='—'; ds.textContent='—'; btn.onclick=null; return; }
    sw.style.background = item.hex; nm.textContent = item.name || 'Sin nombre';
    ds.textContent = `${item.brand||'-'} · ${item.type||'-'} · ${item.style||'-'}`;
    btn.onclick = (e) => {
      e.preventDefault(); e.stopPropagation();
      renderMainCard(item);
      if (item.img) openLightbox(item.img);
    };
  };
  setSub('sub1', b); setSub('sub2', c);
}

/* ======================= Lightbox ======================= */
const lb = document.getElementById('lightbox');
const lbImg = document.getElementById('lb-img');
document.getElementById('lb-close').addEventListener('click', closeLightbox);
lb.addEventListener('click', e=>{ if (e.target===lb) closeLightbox(); });
window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeLightbox(); });
function openLightbox(src){ lbImg.src=''; lb.classList.add('show'); requestAnimationFrame(()=>{ lbImg.src = src; }); }
function closeLightbox(){ lb.classList.remove('show'); lbImg.removeAttribute('src'); }

/* ======================= HEX editable ======================= */
const hexInput = document.getElementById('sel-hex-input');
function applyHexFromInput(){
  const hx = normalizeHex(hexInput.value||'');
  if (!hx) return;
  const rgb = hexToRgb(hx);
  setSelectionFromRGB(rgb);
}
hexInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter') applyHexFromInput(); });
hexInput.addEventListener('blur', applyHexFromInput);

/* ======================= Init ======================= */
window.addEventListener('DOMContentLoaded', async ()=>{
  // Reset
  inputQ.value = '';
  filterType = 'all';
  filterLabel.textContent = 'All';
  Array.from(filterMenu.querySelectorAll('.filter-item')).forEach(x=>x.classList.toggle('active', x.dataset.type==='all'));

  drawVBar();
  drawWheel();
  await cargar();
});
</script>
</body>
</html>
