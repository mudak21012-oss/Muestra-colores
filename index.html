<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hoho3D – Rueda + Búsqueda + Ideas</title>
<style>
  :root{
    --bg:#0b0c0f; --card:#111317; --muted:#9aa1ac; --text:#e8ecf1; --accent:#3b82f6;
    --border:#1b1f28; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
  }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, "Noto Sans", sans-serif; color:var(--text); background:linear-gradient(120deg,#0b0c0f,#0f1218); }
  header{ padding:12px 20px; border-bottom:1px solid var(--border); position:sticky; top:0; background:#0b0c0fd9; backdrop-filter:saturate(140%) blur(6px); display:flex; gap:12px; align-items:center }
  header h1{ margin:0; font-size:16px; font-weight:600; letter-spacing:.2px; white-space:nowrap }
  .search{ position:relative; display:flex; gap:8px; align-items:center; width:100%; max-width:520px; margin-left:auto }
  .input{ width:100%; padding:8px 10px; border-radius:10px; border:1px solid #223047; background:#131824; color:#dbe6f7; font-size:14px }
  .suggestions{ position:absolute; top:42px; left:0; right:0; max-height:320px; overflow:auto; background:var(--card); border:1px solid var(--border); border-radius:10px; padding:6px; display:none; z-index:12 }
  .sug-item{ display:grid; grid-template-columns: 20px 1fr auto; gap:10px; align-items:center; padding:8px; border-radius:8px; cursor:pointer }
  .sug-item:hover{ background:#0f1218 }
  .sug-dot{ width:20px; height:20px; border-radius:6px; border:1px solid var(--border) }
  .sug-meta{ color:var(--muted); font-size:12px }

  .app{ display:grid; grid-template-columns: 520px minmax(420px, 560px); gap:18px; padding:18px; max-width:1180px; margin:0 auto; align-items:start }
  .left{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; display:grid; grid-template-columns: 42px 1fr; gap:16px; align-items:center }
  #loading{ display:none; font-size:14px; color:var(--muted) }
  #wheel{ width:300px; height:300px; display:block; margin:0 auto; border-radius:12px; border:1px solid var(--border); cursor:crosshair }
  .vbar-wrap{ display:flex; flex-direction:column; align-items:center; gap:8px }
  #vbar{ width:28px; height:320px; border-radius:10px; border:1px solid var(--border); cursor:ns-resize; background:linear-gradient(#fff,#000); }
  .tool-mini{ font-size:12px; color:var(--muted); display:flex; flex-direction:column; align-items:center; gap:6px }
  .eyedrop{ appearance:none; border:1px solid #223047; background:#131824; color:#dbe6f7; padding:6px 10px; border-radius:10px; font-size:12px; cursor:pointer }
  .eyedrop:hover{ border-color:#2b3a55 }
  .eyedrop.active{ outline:2px solid var(--accent) }

  .readout{ margin-top:10px; display:flex; align-items:center; gap:12px; color:#cdd7e7; font-size:14px }
  .readout .sw-mini{ width:14px; height:14px; border-radius:4px; border:1px solid var(--border) }
  .hex-edit{ width:160px; padding:8px 10px; border-radius:10px; border:1px solid #223047; background:#131824; color:#dbe6f7; font-size:14px }

  .right{ display:grid; gap:14px }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px }
  .card h2{ margin:0 0 6px 0; font-size:18px }
  .meta{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:14px; color:var(--muted) }
  .meta div strong{ color:var(--text); font-weight:600 }
  .main-sw{ width:100%; height:110px; border-radius:10px; border:1px solid var(--border); margin-bottom:10px }
  .actions{ display:flex; gap:8px; margin-top:8px; align-items:center; flex-wrap:wrap }
  .btn{ appearance:none; border:1px solid #223047; background:#131824; color:#dbe6f7; padding:8px 10px; border-radius:10px; font-size:14px; cursor:pointer }
  .btn:hover{ border-color:#2b3a55 }

  /* Botón-uploader junto a “Creador de Ideas” */
  .uploader{ position:relative; display:flex; align-items:center }
  .uploader input[type=file]{ position:absolute; inset:0; opacity:0; cursor:pointer }
  .btn-ghost{ border:1px dashed #2b3a55; background:#131824; }
  .btn-ghost:hover{ border-style:solid }

  .subs{ display:grid; gap:10px }
  .sub{ display:grid; grid-template-columns: 54px 1fr auto; gap:10px; align-items:center; padding:10px; border:1px solid var(--border); border-radius:12px; background:#0f1218 }
  .sub .sw{ width:54px; height:44px; border-radius:8px; border:1px solid var(--border) }
  .sub h3{ margin:0; font-size:15px }
  .sub small{ color:var(--muted) }
  .sub .btn-mini{ padding:6px 10px; font-size:13px }

  .preview-img{ width:100%; max-width:420px; height:240px; object-fit:cover; border-radius:12px; border:1px solid var(--border); display:block; margin:14px auto 0; }

  /* Lightbox */
  .lightbox{ position:fixed; inset:0; background:rgba(0,0,0,.85); display:none; align-items:center; justify-content:center; z-index:9999; animation:fadeIn .16s ease-out forwards }
  @keyframes fadeIn{ from{ opacity:0 } to{ opacity:1 } }
  .lightbox img{ max-width:min(92vw,1200px); max-height:90vh; display:block; transform:scale(.94); opacity:.0; animation:pop .18s ease-out forwards }
  @keyframes pop{ to{ transform:scale(1); opacity:1 } }
  .lightbox .close{ position:absolute; top:12px; right:12px; padding:8px 10px; border:0; border-radius:8px; background:#fff; cursor:pointer; z-index:2; }
  .muted{ color:var(--muted); font-size:12px }

  /* Sugerencias desplegable (arriba de la tarjeta) */
  .filterbar { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
  .filter-toggle { position:relative; }
  .menu { position:absolute; top:36px; left:0; background:var(--card); border:1px solid var(--border); border-radius:10px; padding:8px; width:220px; display:none; z-index:20 }
  .menu.show{ display:block }
  .menu label{ display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; cursor:pointer; }
  .menu label:hover{ background:#0f1218 }
</style>
</head>
<body>
<header>
  <h1>Hoho3D · Búsqueda por color</h1>
  <div class="search" role="search">
    <input id="q" class="input" type="search" placeholder="Buscar por color, marca o #hex exacto" autocomplete="off" />
    <div id="sugs" class="suggestions" role="listbox" aria-label="Resultados de búsqueda"></div>
  </div>
</header>

<main class="app">
  <!-- IZQUIERDA: Rueda + VBar + Cuentagotas -->
  <section class="left">
    <div class="vbar-wrap">
      <canvas id="vbar" width="28" height="320" aria-label="Luminosidad"></canvas>
      <div class="tool-mini">
        <button id="btn-eyedrop" class="eyedrop" title="Tomar color de cualquier lugar">Cuentagotas</button>
        <span class="muted" style="user-select:none">L</span>
      </div>
    </div>
    <div>
      <div id="loading">Cargando catálogo...</div>
      <canvas id="wheel" width="300" height="300" aria-label="Rueda de color HSV"></canvas>
      <div class="readout">
        <div class="sw-mini" id="sel-sw"></div>
        <div><strong>RGB:</strong> <span id="sel-rgb">—</span></div>
        <div><strong>HEX:</strong>
          <input id="input-hex" class="hex-edit" value="#ffffff" />
        </div>
      </div>
      <img id="preview-img" class="preview-img" alt="Vista previa de filamento" />
    </div>
  </section>

  <!-- DERECHA: Tarjeta principal + filtros + acciones -->
  <section class="right">
    <div class="filterbar">
      <div class="filter-toggle">
        <button id="btn-types" class="btn" type="button">Tipos de filamento ▾</button>
        <div id="menu-types" class="menu" role="menu" aria-label="Filtrar por tipo">
          <!-- Agregar más opciones aquí en el futuro -->
          <label><input type="radio" name="ftype" value="ALL" checked> Todos</label>
          <label><input type="radio" name="ftype" value="PLA"> PLA</label>
          <label><input type="radio" name="ftype" value="PLA+"> PLA+</label>
          <label><input type="radio" name="ftype" value="ABS"> ABS</label>
          <label><input type="radio" name="ftype" value="PETG"> PETG</label>
          <label><input type="radio" name="ftype" value="FLEX"> FLEX</label>
          <label><input type="radio" name="ftype" value="PLAFLEX"> PLAFLEX</label>
        </div>
      </div>
    </div>

    <article class="card" id="main-card" aria-live="polite">
      <div class="main-sw" id="main-sw"></div>
      <h2 id="main-name">—</h2>
      <div class="meta">
        <div><strong>Marca:</strong> <span id="main-brand">—</span></div>
        <div><strong>Tipo:</strong> <span id="main-type">—</span></div>
        <div><strong>Estilo:</strong> <span id="main-style">—</span></div>
        <div><strong>Temp.:</strong> <span id="main-temp">—</span></div>
        <div><strong>Resist.:</strong> <span id="main-strength">—</span></div>
        <div><strong>HEX:</strong> <span id="main-hex">—</span></div>
      </div>

      <div class="actions">
        <a id="main-link" class="btn" href="#" target="_blank" rel="noopener">Abrir en tienda</a>

        <!-- Botón “Creador de Ideas” (lo que ya tenías) -->
        <button id="btn-ideas" class="btn" type="button">Creador de Ideas</button>

        <!-- NUEVO: Cargador de imagen junto al botón -->
        <div class="uploader">
          <button class="btn btn-ghost" type="button" aria-label="Usa una imagen de referencia">Usa una imagen de referencia</button>
          <input id="img-ref" type="file" accept="image/*" />
        </div>
      </div>
    </article>

    <article class="card">
      <h2 style="margin-bottom:8px">Otras sugerencias</h2>
      <div class="subs">
        <div class="sub" id="sub-1">
          <div class="sw" id="sub1-sw"></div>
          <div>
            <h3 id="sub1-name">—</h3>
            <small id="sub1-desc">—</small>
          </div>
          <button class="btn btn-mini" id="sub1-btn">Ver</button>
        </div>
        <div class="sub" id="sub-2">
          <div class="sw" id="sub2-sw"></div>
          <div>
            <h3 id="sub2-name">—</h3>
            <small id="sub2-desc">—</small>
          </div>
          <button class="btn btn-mini" id="sub2-btn">Ver</button>
        </div>
      </div>
    </article>
  </section>
</main>

<!-- Lightbox -->
<div class="lightbox" id="lightbox">
  <button class="close" id="lb-close">Cerrar</button>
  <img id="lb-img" alt="Imagen del filamento" />
</div>

<script>
  const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ-GFIahnmzB09C1GWCvAs1PaNXmpN2_Ed5taWtseTRlqx0P8-ZKJ28TOsvziFOw/pub?output=tsv";

  /* Utilidades */
  const clamp = (n,a,b)=>Math.min(b,Math.max(a,n));
  const norm = s => (s==null? '' : String(s).trim());
  function normalizeHex(h){
    if (typeof h !== 'string') return null;
    const s=h.trim(); const r3=/^#?[0-9a-fA-F]{3}$/, r6=/^#?[0-9a-fA-F]{6}$/;
    if (r3.test(s)){ const p=s.replace('#',''); return '#'+p.split('').map(c=>c+c).join('').toLowerCase(); }
    if (r6.test(s)) return '#'+s.replace('#','').toLowerCase();
    return null;
  }
  function hexToRgb(hex){ const h=hex.replace('#',''); return { r:parseInt(h.slice(0,2),16), g:parseInt(h.slice(2,4),16), b:parseInt(h.slice(4,6),16) }; }
  function rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>clamp(Math.round(v),0,255).toString(16).padStart(2,'0')).join(''); }

  /* RGB <-> HSV */
  function rgbFromHsv(h,s,v){
    if (s===0){ const x=Math.round(v*255); return {r:x,g:x,b:x}; }
    let i=Math.floor(h*6), f=h*6-i;
    const p=v*(1-s), q=v*(1-s*f), t=v*(1-s*(1-f)); i%=6;
    let r,g,b;
    if(i===0){r=v;g=t;b=p;}else if(i===1){r=q;g=v;b=p;}
    else if(i===2){r=p;g=v;b=t;}else if(i===3){r=p;g=q;b=v;}
    else if(i===4){r=t;g=p;b=v;}else{r=v;g=p;b=q;}
    return { r:Math.round(r*255), g:Math.round(g*255), b:Math.round(b*255) };
  }
  function hsvFromRgb(r,g,b){
    r/=255; g/=255; b/=255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b), d=max-min;
    let h=0, s=max===0?0:d/max, v=max;
    if(d!==0){
      switch(max){
        case r: h=(g-b)/d + (g<b?6:0); break;
        case g: h=(b-r)/d + 2; break;
        case b: h=(r-g)/d + 4; break;
      }
      h/=6;
    }
    return { h, s, v };
  }
  function colorDistance(a,b){ const dr=a.r-b.r, dg=a.g-b.g, db=a.b-b.b; return Math.sqrt(dr*dr+dg*dg+db*db); }

  /* Canvas rueda + vbar */
  const wheel = document.getElementById('wheel');
  const wctx = wheel.getContext('2d');
  const CX = wheel.width/2, CY = wheel.height/2, R = 140;

  const vbar = document.getElementById('vbar');
  const vctx = vbar.getContext('2d');

  let V = 1.0;            // luminosidad global (slider)
  let curH = 0.0, curS = 0.0; // track de selección (para mantener tono/sat con V)
  let isDragWheel=false, isDragV=false;

  function drawWheel(){
    const img = wctx.createImageData(wheel.width, wheel.height);
    for(let y=0; y<wheel.height; y++){
      for(let x=0; x<wheel.width; x++){
        const dx=x-CX, dy=y-CY; const dist=Math.sqrt(dx*dx+dy*dy);
        const idx=(y*wheel.width+x)*4;
        if (dist<=R){
          let ang=Math.atan2(dy,dx); if(ang<0) ang+=Math.PI*2;
          const h=ang/(Math.PI*2), s=dist/R;
          const {r,g,b} = rgbFromHsv(h,s,V); // <- V global
          img.data[idx]=r; img.data[idx+1]=g; img.data[idx+2]=b; img.data[idx+3]=255;
        }else{
          img.data[idx+3]=0;
        }
      }
    }
    wctx.putImageData(img,0,0);
  }
  function drawVBar(){
    const grd=vctx.createLinearGradient(0,0,0,vbar.height);
    grd.addColorStop(0,'#ffffff'); grd.addColorStop(1,'#000000');
    vctx.fillStyle=grd; vctx.fillRect(0,0,vbar.width,vbar.height);
    // indicador
    const y=(1-V)*vbar.height;
    vctx.fillStyle='#fff8'; vctx.fillRect(0, y-2, vbar.width, 4);
  }

  function updateFromWheel(clientX,clientY){
    const rect=wheel.getBoundingClientRect();
    const sx=wheel.width/rect.width, sy=wheel.height/rect.height;
    const x=(clientX-rect.left)*sx, y=(clientY-rect.top)*sy;
    const dx=x-CX, dy=y-CY; const dist=Math.sqrt(dx*dx+dy*dy);
    if (dist>R) return;
    let ang=Math.atan2(dy,dx); if(ang<0) ang+=Math.PI*2;
    const h=ang/(Math.PI*2), s=dist/R;
    curH=h; curS=s;
    const {r,g,b}=rgbFromHsv(h,s,V);
    applySelected({r,g,b});
  }
  function updateFromVBar(clientY){
    const rect=vbar.getBoundingClientRect();
    const y=clamp(clientY-rect.top,0,rect.height);
    V=clamp(1-(y/rect.height),0,1);
    drawVBar(); drawWheel();
    const {r,g,b}=rgbFromHsv(curH,curS,V);
    applySelected({r,g,b}, false);
  }

  /* Dataset */
  let items=[], pool=[], lastRGB=null, typeFilter='ALL';

  async function cargar(){
    const el=document.getElementById('loading'); el.style.display='block';
    try{
      const res=await fetch(sheetUrl,{cache:'no-store',mode:'cors'}); if(!res.ok) throw new Error('HTTP '+res.status);
      let txt=await res.text(); if(/<\s*html/i.test(txt)) throw new Error('La URL devolvió HTML. Publica como TSV/CSV');
      txt=txt.replace(/^\uFEFF/,'').replace(/\r\n/g,'\n');
      const head=txt.split('\n')[0]; const delim=head.includes('\t')?'\t':',';
      const rows=txt.trim().split('\n').map(l=>l.split(delim));
      const headers=rows.shift().map(h=>h.replace(/^"(.*)"$/,'$1').toLowerCase().trim());
      const ix=k=>headers.indexOf(k);
      const idx={
        id: ix('id'),
        name: headers.includes('name')?ix('name'):ix('nombre'),
        hex: ix('hex'),
        brand: headers.includes('brand')?ix('brand'):ix('marca'),
        type: headers.includes('type')?ix('type'):ix('tipo'),
        style: headers.includes('style')?ix('style'):ix('estilo'),
        temp: headers.includes('temp')?ix('temp'):ix('temperatura'),
        strength: headers.includes('strength')?ix('strength'):ix('resistencia'),
        link: headers.includes('link')?ix('link'):ix('url'),
        img: headers.includes('img')?ix('img'): (headers.includes('image')?ix('image'):-1),
        ideas: headers.includes('ideas')?ix('ideas'): -1
      };
      if (idx.hex===-1) throw new Error('Falta columna HEX');
      items=[];
      rows.forEach(r=>{
        const hex=normalizeHex(r[idx.hex]||''); if(!hex) return;
        const ob={
          id: idx.id!==-1? norm(r[idx.id]):'',
          name: idx.name!==-1? norm(r[idx.name]):'',
          hex, rgb: hexToRgb(hex),
          brand: idx.brand!==-1? norm(r[idx.brand]):'',
          type: idx.type!==-1? norm(r[idx.type]):'',
          style: idx.style!==-1? norm(r[idx.style]):'',
          temp: idx.temp!==-1? norm(r[idx.temp]):'',
          strength: idx.strength!==-1? norm(r[idx.strength]):'',
          link: idx.link!==-1? norm(r[idx.link]): '#',
          img: idx.img!==-1? norm(r[idx.img]):'',
          ideas: idx.ideas!==-1? norm(r[idx.ideas]):''
        };
        items.push(ob);
      });
      pool=items.slice();
    }catch(e){ console.error(e); }
    finally{ el.style.display='none'; }
  }

  /* Ranking + render */
  function rankAndRenderBy(rgb){
    let list=items;
    if (typeFilter!=='ALL') list=list.filter(it=>(it.type||'').toUpperCase()===typeFilter);
    const ranked=list.map(it=>({it, d:colorDistance(rgb,it.rgb)})).sort((a,b)=>a.d-b.d).slice(0,3).map(x=>x.it);
    renderSide(ranked);
  }
  function renderMainCard(a){
    if(!a) return;
    document.getElementById('main-sw').style.background=a.hex;
    document.getElementById('main-name').textContent=a.name||'Sin nombre';
    document.getElementById('main-brand').textContent=a.brand||'-';
    document.getElementById('main-type').textContent=a.type||'-';
    document.getElementById('main-style').textContent=a.style||'-';
    document.getElementById('main-temp').textContent=a.temp||'-';
    document.getElementById('main-strength').textContent=a.strength||'-';
    document.getElementById('main-hex').textContent=a.hex;
    document.getElementById('main-link').href=a.link||'#';

    const prev=document.getElementById('preview-img');
    if(a.img){
      prev.src=a.img; prev.alt=`Vista previa ${a.name}`; prev.style.visibility='visible';
      prev.onerror=()=>{ prev.removeAttribute('src'); prev.style.visibility='hidden'; };
      prev.onclick=()=>openLightbox(a.img);
    }else{
      prev.removeAttribute('src'); prev.style.visibility='hidden'; prev.onclick=null;
    }
  }
  function renderSide(top){
    const [a,b,c]=top; if(!a) return;
    renderMainCard(a);
    const setSub=(sub,item)=>{
      const sw=document.getElementById(sub+'-sw');
      const nm=document.getElementById(sub+'-name');
      const ds=document.getElementById(sub+'-desc');
      const btn=document.getElementById(sub+'-btn');
      if(!item){ sw.style.background='transparent'; nm.textContent='—'; ds.textContent='—'; btn.onclick=null; return; }
      sw.style.background=item.hex; nm.textContent=item.name||'Sin nombre';
      ds.textContent=`${item.brand||'-'} · ${item.type||'-'} · ${item.style||'-'}`;
      btn.onclick=(e)=>{ e.preventDefault(); renderMainCard(item); if(item.img) openLightbox(item.img); };
    };
    setSub('sub1', b); setSub('sub2', c);
  }
  function applySelected({r,g,b}, doRank=true){
    lastRGB={r,g,b};
    const hex=rgbToHex(r,g,b);
    document.getElementById('sel-sw').style.background=hex;
    document.getElementById('sel-rgb').textContent=`${r}, ${g}, ${b}`;
    document.getElementById('input-hex').value=hex;
    if (doRank) rankAndRenderBy({r,g,b});
  }

  /* Interacción rueda + vbar */
  wheel.addEventListener('mousedown', e=>{ isDragWheel=true; updateFromWheel(e.clientX,e.clientY); });
  window.addEventListener('mousemove', e=>{ if(isDragWheel) updateFromWheel(e.clientX,e.clientY); });
  window.addEventListener('mouseup', ()=> isDragWheel=false);

  vbar.addEventListener('mousedown', e=>{ isDragV=true; updateFromVBar(e.clientY); });
  window.addEventListener('mousemove', e=>{ if(isDragV) updateFromVBar(e.clientY); });
  window.addEventListener('mouseup', ()=> isDragV=false);

  /* Editable HEX */
  const inputHex=document.getElementById('input-hex');
  inputHex.addEventListener('change', ()=>{
    const hx=normalizeHex(inputHex.value); if(!hx){ inputHex.value='#ffffff'; return; }
    const {r,g,b}=hexToRgb(hx);
    const {h,s,v}=hsvFromRgb(r,g,b);
    curH=h; curS=s; V=v; drawVBar(); drawWheel();
    applySelected({r,g,b});
  });

  /* Buscador */
  const inputQ=document.getElementById('q');
  function hideSugs(){ const sugs=document.getElementById('sugs'); sugs.style.display='none'; sugs.innerHTML=''; }
  function showSugs(){ document.getElementById('sugs').style.display='block'; }
  function renderSugs(q,list){
    const box=document.getElementById('sugs'); box.innerHTML='';
    const LIM=100, out=list.slice(0,LIM); if(!out.length){ hideSugs(); return; }
    out.forEach(it=>{
      const div=document.createElement('div'); div.className='sug-item';
      const dot=document.createElement('span'); dot.className='sug-dot'; dot.style.background=it.hex;
      const text=document.createElement('div'); text.innerHTML=`<strong>${it.name||'(Sin nombre)'}</strong><div class="sug-meta">${it.brand||'-'} · ${it.hex}</div>`;
      const go=document.createElement('div'); go.textContent='ver'; go.style.fontSize='12px'; go.style.color='var(--accent)';
      div.appendChild(dot); div.appendChild(text); div.appendChild(go);
      div.onclick=()=>{ hideSugs(); inputQ.value=it.name||it.hex; const {r,g,b}=it.rgb; const hsv=hsvFromRgb(r,g,b); curH=hsv.h; curS=hsv.s; V=hsv.v; drawVBar(); drawWheel(); applySelected(it.rgb); };
      box.appendChild(div);
    });
    showSugs();
  }
  inputQ.addEventListener('input', (e)=>{
    let q=(e.target.value||'').trim().toLowerCase(); let list=items.slice();
    if (!q){ hideSugs(); if(lastRGB) rankAndRenderBy(lastRGB); return; }
    if (q.startsWith('#')){ const hx=normalizeHex(q)||''; list=list.filter(it=>it.hex.startsWith(hx)); }
    else { list=list.filter(it=>(it.name||'').toLowerCase().includes(q)||(it.brand||'').toLowerCase().includes(q)); }
    renderSugs(q,list);
    if (lastRGB) rankAndRenderBy(lastRGB);
  });
  inputQ.addEventListener('focus', ()=>{ if(inputQ.value) renderSugs(inputQ.value, items); });
  document.addEventListener('click', (e)=>{ const sugs=document.getElementById('sugs'); if (!sugs.contains(e.target) && e.target!==inputQ) hideSugs(); });

  /* Menú Tipos (filtro por type) */
  const btnTypes=document.getElementById('btn-types');
  const menuTypes=document.getElementById('menu-types');
  btnTypes.addEventListener('click', ()=> menuTypes.classList.toggle('show'));
  menuTypes.addEventListener('click', (e)=>{
    const r=e.target.closest('input[type=radio][name=ftype]');
    if(!r) return;
    typeFilter=r.value.toUpperCase();
    menuTypes.classList.remove('show');
    if(lastRGB) rankAndRenderBy(lastRGB);
  });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') menuTypes.classList.remove('show'); });
  document.addEventListener('click', e=>{ if(!menuTypes.contains(e.target) && e.target!==btnTypes) menuTypes.classList.remove('show'); });

  /* Lightbox */
  function openLightbox(src){ if(!src) return; const lb=document.getElementById('lightbox'); const img=document.getElementById('lb-img'); img.src=src; lb.style.display='flex'; }
  function closeLightbox(){ const lb=document.getElementById('lightbox'); const img=document.getElementById('lb-img'); img.removeAttribute('src'); lb.style.display='none'; }
  document.getElementById('lb-close').addEventListener('click', closeLightbox);
  document.getElementById('lightbox').addEventListener('click', e=>{ if(e.target.id==='lightbox') closeLightbox(); });
  document.getElementById('lb-img').addEventListener('click', e=>e.stopPropagation());
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeLightbox(); });

  /* Cuentagotas */
  const eyedropBtn=document.getElementById('btn-eyedrop');
  let eyedropActive=false;
  eyedropBtn.addEventListener('click', ()=>{
    eyedropActive=!eyedropActive;
    eyedropBtn.classList.toggle('active', eyedropActive);
    document.body.style.cursor = eyedropActive ? "url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22 viewBox=%220 0 24 24%22><path d=%22M2 21l6-6 1 1 8-8-2-2 2-2 4 4-2 2-2-2-8 8 1 1-6 6H2z%22 fill=%22%23e8ecf1%22/></svg>') 2 18, crosshair" : "default";
  });
  document.addEventListener('click', (e)=>{
    if(!eyedropActive) return;
    const x=e.clientX, y=e.clientY;
    // Usamos eyedrop con getImageData del wheel si clic dentro del canvas; si no, usamos color aproximado por CSS (fallback)
    const r=wheel.getBoundingClientRect();
    if (x>=r.left && x<=r.right && y>=r.top && y<=r.bottom){
      updateFromWheel(x,y);
    }
    eyedropActive=false; eyedropBtn.classList.remove('active'); document.body.style.cursor='default';
  });

  /* Dominant color desde imagen */
  document.getElementById('img-ref').addEventListener('change', async (e)=>{
    const file=e.target.files && e.target.files[0]; if(!file) return;
    const url=URL.createObjectURL(file);
    const img=new Image(); img.src=url; await img.decode();
    const col = await dominantColor(img);
    URL.revokeObjectURL(url);
    const {r,g,b}=col;
    const hsv=hsvFromRgb(r,g,b); curH=hsv.h; curS=hsv.s; V=hsv.v;
    drawVBar(); drawWheel();
    applySelected({r,g,b});
  });

  async function dominantColor(image){
    // Escalamos para muestrear rápido
    const W=160, H=Math.round(image.height*(W/image.width));
    const c=document.createElement('canvas'); c.width=W; c.height=H;
    const xctx=c.getContext('2d',{willReadFrequently:true});
    xctx.drawImage(image,0,0,W,H);
    const data=xctx.getImageData(0,0,W,H).data;

    // Bins por HEX “redondeado” + puntaje por saturación: penaliza grises/blancos/negros
    const bins=new Map();
    for(let i=0;i<data.length;i+=4){
      const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
      if (a<200) continue; // ignora transparente
      const {h,s,v}=hsvFromRgb(r,g,b);
      if (v>0.92 || v<0.12) continue;   // ignora blanco/negro/fondo
      if (s<0.25) continue;             // ignora grises
      // redondeo a pasos de 16 para agrupar
      const rr=(r/16|0)*16, gg=(g/16|0)*16, bb=(b/16|0)*16;
      const key=`${rr},${gg},${bb}`;
      const weight = 1 + s*1.5 + (0.5 - Math.abs(v-0.5)); // favorece saturación y medios
      bins.set(key, (bins.get(key)||0)+weight);
    }
    // fallback: si quedó vacío, toma promedio simple
    if (bins.size===0){
      let tr=0,tg=0,tb=0, n=0;
      for(let i=0;i<data.length;i+=4){ tr+=data[i]; tg+=data[i+1]; tb+=data[i+2]; n++; }
      return {r:Math.round(tr/n), g:Math.round(tg/n), b:Math.round(tb/n)};
    }
    let bestKey=null, bestVal=-1;
    for(const [k,v] of bins.entries()){ if(v>bestVal){ bestVal=v; bestKey=k; } }
    const [r,g,b]=bestKey.split(',').map(Number);
    return {r,g,b};
  }

  /* Init */
  window.addEventListener('DOMContentLoaded', async ()=>{
    drawVBar(); drawWheel();
    await cargar();
  });
</script>
</body>
</html>
